# 日程調整

## 日程調整の概要

TaskApp の日程調整機能（Scheduling Proposal）は、クライアントとの会議日程を効率的に決定するための仕組みです。候補日を複数提案し、参加者の回答を集約して、最適な日時で会議を確定します。

### 基本フロー

```
1. 候補日を提案（2〜5個のスロット）
          ↓
2. 参加者が回答（3択で各スロットに回答）
          ↓
3. 回答状況をリアルタイムで確認
          ↓
4. 条件を満たすスロットで確定
          ↓
5. 会議が自動作成 + ビデオ会議URL生成
```

### ステータス一覧

| ステータス | 色 | 意味 |
|-----------|-----|------|
| `open` | 青 | 回答受付中 |
| `confirmed` | 緑 | 日程確定済み |
| `cancelled` | グレー | キャンセル済み |
| `expired` | 赤 | 有効期限切れ |

---

## 日程提案の作成

### 手順

1. 会議一覧画面で「日程調整」ボタンをクリックする
2. 作成シートが表示される
3. 以下の項目を入力する

| 項目 | 必須 | 説明 | 制限 |
|------|------|------|------|
| タイトル | 必須 | 提案のタイトル（例: 「第2回定例会議 日程調整」） | 1〜200文字 |
| 説明 | 任意 | 補足説明 | 最大1,000文字 |
| 所要時間 | 必須 | 会議の予定時間 | 15〜480分 |
| 候補日時 | 必須 | 開始日時と終了日時のペア | 2〜5個、未来日時のみ |
| 参加者 | 必須 | 回答を求めるメンバー | 1〜50人、クライアント1人以上必須 |
| ビデオ会議 | 任意 | 使用するビデオ会議ツール | Google Meet / Zoom / Teams |
| 有効期限 | 任意 | 回答の締め切り | 設定しない場合は無期限 |

4. 「提案を送信」ボタンをクリックする
5. 全参加者に通知が送信される

### 候補日時の設定

候補日時は2〜5個のスロットを設定します。

1. 「候補日時を追加」ボタンで新しいスロットを追加する
2. 各スロットの開始日時と終了日時を入力する
3. 不要なスロットは削除ボタンで削除する

> **注意**: 過去の日時は設定できません。また、終了日時は開始日時より後でなければなりません。

### 参加者の選択

参加者は社内メンバーとクライアントから選択します。

> **注意**: 会議にはクライアント参加者が最低1名必要です（AT-001準拠）。クライアント参加者が0名の場合、提案を保存できません。

---

## 参加者の回答

提案を受け取った参加者は、各候補日時に対して回答します。

### 3つの選択肢

| 選択肢 | アイコン | 内部向け表示 | クライアント向け表示 | 確定判定 |
|--------|---------|-------------|-------------------|---------|
| `available` | 丸 | 参加可能 | 参加できます | 可 |
| `unavailable_but_proceed` | 三角 | 欠席OK | 欠席しますが進めてください | 可 |
| `unavailable` | バツ | 参加不可 | 参加できません | 不可 |

### 回答手順（社内メンバー）

1. 通知から日程調整の詳細画面を開く
2. 各候補日時に対して3択から選択する
3. 「回答を送信」ボタンをクリックする
4. 回答が保存され、提案作成者に通知される

### 回答手順（クライアント）

1. クライアントポータルで通知を確認する
2. 日程調整カードの「回答する」ボタンをクリックする
3. 各候補日時に対して回答する
4. 「回答を送信」ボタンをクリックする

### リアルタイム更新

回答状況はリアルタイムで更新されます。提案の詳細画面（インスペクター）には「Live」バッジが表示され、他の参加者の回答がリアルタイムで反映されます。

> **Tips**: 提案作成者は、全員の回答を待たずに回答状況を随時確認できます。

---

## 回答状況の確認

### マトリクス表示

提案のインスペクター（右ペイン 400px）には、回答状況がマトリクス形式で表示されます。

```
         │ 2/15 10:00 │ 2/16 14:00 │ 2/17 10:00 │
─────────┼────────────┼────────────┼────────────┤
田中(C)  │     ○      │     △      │     ×      │
鈴木(C)  │     ○      │     ○      │     △      │
高木(I)  │     ○      │     ×      │     ○      │
─────────┼────────────┼────────────┼────────────┤
確定可否  │     ○      │     ×      │     ○      │
```

- (C) = クライアント、(I) = 社内メンバー
- 丸 = `available`、三角 = `unavailable_but_proceed`、バツ = `unavailable`
- 確定可否: 全員が `available` または `unavailable_but_proceed` のスロットは確定可能

---

## 確定操作

全参加者の回答が揃い、確定可能なスロットがある場合に日程を確定します。

### 確定条件

- 提案のステータスが `open` であること
- 確定するスロットで、全参加者が `available` または `unavailable_but_proceed` と回答していること
- 参加者が1人以上いること

### 手順

1. 提案のインスペクターで回答状況を確認する
2. 確定可能なスロット（全員が参加可能または欠席OK）を選択する
3. 「この日程で確定」ボタンをクリックする
4. 確認ダイアログで「確定する」を選択する

### 確定時の自動処理

確定すると、以下の処理が自動的に実行されます。

| 処理 | 内容 |
|------|------|
| 会議作成 | 確定したスロットの日時で会議が自動作成される |
| 参加者コピー | 提案の参加者が会議の参加者として登録される |
| ビデオ会議URL | ビデオ会議プロバイダーが設定されている場合、URLが自動生成される |
| 通知送信 | 全参加者に確定通知が送信される |
| ステータス更新 | 提案のステータスが `confirmed` に変更される |

> **注意**: ビデオ会議URLの生成に失敗しても、日程の確定自体はブロックされません。URLは後から手動で追加できます。

### 確定権限

日程を確定できるのは以下のユーザーです。

| ユーザー | 確定可否 |
|---------|---------|
| 提案の作成者 | 可能 |
| スペースの admin | 可能 |
| その他のメンバー | 不可 |

---

## キャンセル

提案が不要になった場合、キャンセルできます。

1. 提案のインスペクターを開く
2. 「キャンセル」ボタンをクリックする
3. 確認ダイアログで「キャンセルする」を選択する
4. ステータスが `cancelled` に変更される

> **注意**: キャンセルは提案の作成者またはスペースの admin のみ実行できます。

---

## Googleカレンダー連携

Googleカレンダーと連携すると、参加者の空き状況を確認しながら候補日時を設定できます。

### OAuth設定

1. プロジェクトの設定ページを開く
2. 「Googleカレンダー」セクションを表示する
3. 「Googleカレンダーに接続」ボタンをクリックする
4. Googleアカウントの認証画面が表示される
5. カレンダーへのアクセスを許可する
6. 設定画面にリダイレクトされ、接続状態が「接続済み」に変わる

### FreeBusy表示

Googleカレンダーが接続されている場合、候補日時の設定時に参加者の空き状況を確認できます。

- **空き時間**: スロットが緑色で表示
- **予定あり**: スロットが赤色で表示

> **Tips**: FreeBusy表示を活用することで、参加者の予定を事前に確認でき、確定率の高い候補日時を設定できます。

### カレンダーイベント自動作成

日程が確定すると、Googleカレンダーにイベントが自動作成されます。

---

## ビデオ会議連携

日程提案時にビデオ会議プロバイダーを選択すると、確定時にビデオ会議URLが自動生成されます。

### 対応プロバイダー

| プロバイダー | 認証方式 | 備考 |
|------------|---------|------|
| **Google Meet** | ユーザーOAuth（Googleカレンダー連携必須） | Googleカレンダーの予定にビデオ会議を追加する形式 |
| **Zoom** | ユーザーOAuth | 個人アカウントのOAuth接続が必要 |
| **Microsoft Teams** | ユーザーOAuth | Microsoft 365アカウントが必要 |

### デフォルトプロバイダーの設定

プロジェクト設定で、日程提案時のデフォルトビデオ会議プロバイダーを設定できます。

1. 設定 > ビデオ会議セクションを開く
2. デフォルトプロバイダーを選択する
3. 設定が保存される

> **Tips**: デフォルトプロバイダーを設定すると、日程提案作成時にビデオ会議の種類が自動選択されます。

---

## リマインダー

日程調整のリマインダーは自動的に送信されます（pg_cronによる定期実行）。

### リマインダーの種類

| タイプ | 条件 | 送信先 | メッセージ |
|-------|------|-------|----------|
| 期限前リマインダー | 回答期限が24時間以内 + 未回答 | 未回答の参加者 | 「回答期限が明日です」 |
| 未回答リマインダー | 提案作成から48時間経過 + 未回答者あり | 提案の作成者 | 「○○さんがまだ回答していません」 |

> **Tips**: リマインダーは自動的に送信されるため、手動でのフォローアップの手間を削減できます。同じリマインダーが重複送信されることはありません。

---

## 有効期限と自動期限切れ

### 有効期限の設定

日程提案に有効期限を設定できます。期限を過ぎると自動的にステータスが `expired` に変更されます。

### 自動期限切れ処理

- 5分間隔で自動チェック（pg_cron）
- `status = 'open'` かつ `expires_at < 現在時刻` の提案を `expired` に更新
- 作成者に期限切れの通知が送信される

---

## 通知一覧

日程調整に関連する通知の一覧です。

| イベント | タイミング | 送信先 |
|---------|----------|-------|
| 提案作成 | 日程提案が作成されたとき | 全参加者 |
| 回答送信 | 参加者が回答を送信したとき | 提案の作成者 |
| 日程確定 | スロットが確定されたとき | 全参加者 |
| 期限切れ | 提案の有効期限が切れたとき | 提案の作成者 |
| リマインダー | 期限前24時間 / 作成後48時間 | 未回答者 または 作成者 |

---

## 全候補が不可の場合

すべての候補スロットで「参加不可」の回答があり、確定可能なスロットが1つもない場合の対処方法です。

### 状況の確認

回答状況マトリクスで、すべてのスロットの確定可否が「×」になっている場合、現在の候補では日程を確定できません。

### 対処手順

1. 現在の提案をキャンセルする（提案のインスペクター >「キャンセル」ボタン）
2. 参加者に個別に連絡し、都合のよい日時を確認する
3. 新しい候補日時で日程提案を再作成する

> **Tips**: 再提案時は、Google カレンダー連携の FreeBusy 表示を活用して、参加者の空き状況を事前に確認してから候補を設定すると、確定率が上がります。

---

## 確定後の変更

日程が確定された後に変更が必要になった場合の対処方法です。

### 確定済みの日程を変更する

確定済みの提案を直接編集することはできません。以下の手順で対応してください。

1. 確定済みの提案に紐づく会議を確認する
2. 必要に応じて会議の日時を手動で変更する、または会議を削除する
3. 新しい日程提案を作成し、参加者に回答を依頼する

### 確定後にキャンセルする場合

1. 確定済みの会議を削除または日時を変更する
2. 参加者にキャンセルの旨を連絡する（コメントまたは個別連絡）

> **注意**: 確定後の変更は参加者に混乱を招く可能性があります。確定前に全参加者の回答内容を十分に確認してから確定してください。

---

## 日程調整のベストプラクティス

### 候補日時の設定

- 候補日時は**3〜4個**程度が最適です。多すぎると回答に時間がかかります
- 参加者の一般的な稼働時間帯に合わせて設定してください
- Googleカレンダー連携を活用し、事前に空き状況を確認してから候補を設定してください

### 回答の促進

- 有効期限を設定することで、回答の締め切りを明確にできます
- リマインダーが自動送信されますが、急ぎの場合は個別に連絡してください

### 確定のタイミング

- 全員の回答が揃ったら速やかに確定してください
- 全員が `available` のスロットを優先的に選択してください
- `unavailable_but_proceed`（欠席OK）の参加者がいるスロットは、その参加者に事前確認することを推奨します
