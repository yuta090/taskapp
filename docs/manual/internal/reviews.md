# レビュー・承認

## レビューシステムの概要

TaskApp のレビューシステムは、タスクや仕様決定に対する承認プロセスを管理します。「誰がレビューしたか」の証跡を自動記録し、監査グレードの品質管理を実現します。

### レビューシステムの特徴

| 特徴 | 説明 |
|------|------|
| 必須レビュアー制度 | 指名されたレビュアーが全員承認しないと完了にならない |
| 任意レビュー | 指名なしの場合、誰でもレビュー・承認が可能 |
| 差し戻し時の部分維持 | 変更箇所のみ再承認が必要。承認済みの項目はリセットされない |
| 監査証跡 | レビュアー名、タイムスタンプ、関連会議IDを自動記録 |

---

## レビュー対象

レビューは以下の2種類のアイテムに対して実施できます。

| 対象 | 説明 | 用途 |
|------|------|------|
| **タスク** (`type = 'task'`) | 通常の作業タスク | 成果物の品質確認、完了確認 |
| **仕様決定** (`type = 'spec'`) | 仕様に関する意思決定 | クライアントとの合意確認、設計方針の承認 |

> **注意**: 仕様決定タスク（`type = 'spec'`）には `spec_path`（仕様書のパス）と `decision_state`（決定状態）が必須です。

---

## レビューステータス

レビューには以下の4つのステータスがあります。

| ステータス | 表示 | 意味 |
|-----------|------|------|
| `pending` | レビュー待ち | レビュアーの対応を待っている状態 |
| `approved` | 承認済み | レビュアーが内容を承認した状態 |
| `changes_requested` | 変更依頼 | レビュアーが修正を求めている状態 |
| `rejected` | 却下 | レビュアーが内容を却下した状態 |

### ステータスの遷移

```
                    ┌──────────────┐
                    │   pending    │
                    │ (レビュー待ち) │
                    └──────┬───────┘
                           │
              ┌────────────┼────────────┐
              v            v            v
     ┌────────────┐ ┌───────────┐ ┌──────────┐
     │  approved  │ │ changes_  │ │ rejected │
     │  (承認済み)  │ │ requested │ │  (却下)   │
     └────────────┘ │(変更依頼)  │ └──────────┘
                    └─────┬─────┘
                          │ 修正後
                          v
                    ┌──────────────┐
                    │   pending    │
                    │  (再レビュー)  │
                    └──────────────┘
```

---

## レビューの作成・依頼

### 必須レビュアーを指定する場合

1. タスクのインスペクター（右ペイン）を開く
2. 「レビュー」セクションを表示する
3. 「レビュアーを追加」ボタンをクリックする
4. レビュアーとなるメンバーを選択する（複数選択可）
5. レビューが `pending` ステータスで作成される
6. 指名されたレビュアーに通知が送信される

> **Tips**: 必須レビュアーを指定した場合、全員が承認しないとレビュー完了になりません。重要な意思決定には複数のレビュアーを指名することを推奨します。

### 任意レビュー（指名なし）の場合

1. タスクのインスペクター（右ペイン）を開く
2. 「レビュー」セクションでレビュアーを指定せずにレビュー依頼を作成する
3. プロジェクトメンバーの誰でもレビュー・承認が可能になる

> **Tips**: 軽微な確認事項やチーム内の共有事項には、任意レビュー（指名なし）が便利です。

---

## レビューの実施方法

レビュアーとして指名された場合、または任意レビューに参加する場合の手順です。

### 承認（approve）

内容に問題がない場合に承認します。

1. レビュー対象のタスクをクリックしてインスペクターを開く
2. レビュー内容（タスクの説明、添付ファイルなど）を確認する
3. 「承認」ボタンをクリックする
4. ステータスが `approved` に変わる

### 変更依頼（request changes）

修正が必要な場合に変更を依頼します。

1. レビュー対象のタスクのインスペクターを開く
2. 内容を確認し、修正が必要な箇所を特定する
3. 「変更依頼」ボタンをクリックする
4. コメント欄に修正内容を具体的に記載する
   - 修正箇所の指摘
   - 期待する修正内容
   - 参考情報（必要な場合）
5. 送信する
6. タスクの担当者に変更依頼の通知が送信される

> **Tips**: 変更依頼のコメントは具体的に書くことで、修正のやり取りを減らせます。「ここを直してください」ではなく、「XXの部分をYYに変更してください。理由はZZです」のように記載してください。

### 却下（reject）

内容が根本的に見直しが必要な場合に却下します。

1. レビュー対象のタスクのインスペクターを開く
2. 「却下」ボタンをクリックする
3. 却下理由をコメント欄に記載する
   - なぜ却下するのか
   - どのような方向性で再検討すべきか
4. 送信する

> **注意**: 却下は「最初からやり直し」を意味するため、軽微な修正の場合は「変更依頼」を使用してください。

---

## 再提出ワークフロー

変更依頼（`changes_requested`）を受けた後の再提出プロセスです。

### 基本ルール

- **変更箇所のみ**再承認が必要
- 未変更の承認は**維持される**（ゼロからやり直しにならない）
- 修正後、レビュアーに再レビューの通知が送信される

### 手順

1. 変更依頼のコメントを確認する
2. 指摘された箇所を修正する
3. 修正内容を更新する
4. レビュアーに再レビューを依頼する（自動通知）
5. レビュアーが修正箇所を確認し、承認または再度変更依頼を行う

### 複数レビュアーの場合

| 状態 | 説明 |
|------|------|
| レビュアーA: 承認済み、レビュアーB: 変更依頼 | Bの指摘箇所を修正後、Bのみ再承認すればよい。Aの承認は維持 |
| 全レビュアー: 承認済み | レビュー完了 |

> **Tips**: 差し戻し後も既に通ったチェック項目は維持されるため、レビューのコストを最小限に抑えられます。

---

## 監査証跡

TaskApp のレビューシステムは、意思決定の証拠を自動的に記録します。

### 記録される情報

| 項目 | 内容 |
|------|------|
| レビュアー名 | 誰がレビューしたか |
| タイムスタンプ | いつレビューしたか |
| ステータス変更 | どのような判断をしたか（承認/変更依頼/却下） |
| コメント | レビュー時のコメント内容 |
| 会議ID | 関連する会議がある場合、その会議への紐づけ |

### 仕様決定（spec）の監査

仕様決定タスクでは、追加の証跡が記録されます。

| イベント | 記録内容 |
|---------|---------|
| `spec_decided` | 仕様が決定された記録。`evidence='meeting'` で会議での決定を示す |
| 会議内決定 | `meeting_id` が紐づけられ、どの会議で決定されたかを追跡可能 |
| クライアント確定 | `on_behalf_of='client'` で、クライアントの代理決定を記録。確認相手・根拠も保存 |

### 入力者と意思決定者の分離

監査の信頼性を高めるため、「入力した人」と「意思決定をした人」は明確に分離されます。

| フィールド | 内容 |
|-----------|------|
| `actor_id` | 実際にシステムで操作した人（社内メンバー） |
| `on_behalf_of` | 代理であることを示すフラグ（`'client'`） |
| `client_confirmed_by` | 実際に意思決定したクライアント担当者 |

> **注意**: この分離により、「社内メンバーがクライアントの代わりに入力した」場合でも、誰の意思決定かが正確に記録されます。

---

## クライアントのレビュー

クライアントはポータル画面からレビューに参加できます。

### クライアント側の機能

- レビュー専用リストの閲覧（今日チェックすべきもの / 期限切れ / すべて）
- タスクの詳細確認
- コメントの投稿
- レビューチェックの完了

> **Tips**: クライアントには「今日どれをチェックすればいいか」が明確に表示されます。期限が近いものが優先的に表示されるため、見落としを防げます。

---

## レビュアーの変更

レビュー依頼後にレビュアーを変更する必要がある場合の手順です。

### レビュアーの追加

1. タスクのインスペクター（右ペイン）を開く
2. 「レビュー」セクションを表示する
3. 「レビュアーを追加」ボタンをクリックする
4. 新しいレビュアーを選択する
5. 追加されたレビュアーに通知が送信される

### レビュアーの削除

レビュアーを削除する場合は、該当レビュアーのレビューエントリを削除します。

> **注意**: 既に承認済みのレビュアーを削除すると、その承認記録も削除されます。必要に応じて、削除前にレビュー履歴を確認してください。

### レビュアーが不在の場合

必須レビュアーが長期不在の場合は、以下の対応を検討してください。

1. 不在のレビュアーを削除する
2. 代替のレビュアーを追加する
3. 代替レビュアーに経緯をコメントで共有する

---

## 期限超過時の対応

レビューが長期間対応されない場合の運用方法です。

### レビュー停滞の確認

レビューが `pending` のまま長期間経過している場合、以下を確認してください。

| チェック項目 | 対処法 |
|-------------|--------|
| レビュアーが通知を見落としている | レビュアーに直接連絡する（Slack やメール） |
| レビュアーが多忙で対応できない | 代替レビュアーの追加を検討する |
| レビュー内容が不明確 | タスクのコメントで補足説明を追加する |

### 推奨対応フロー

1. レビュー依頼から **3営業日** 経過しても対応がない場合、レビュアーに個別にリマインドする
2. **5営業日** 経過した場合、プロジェクトの admin に相談し、代替レビュアーの追加を検討する
3. 緊急度が高い場合は、レビュアーを変更して速やかに対応する

> **Tips**: レビュー依頼時にコメントで期限の目安を伝えておくと（例:「2/15 までにご確認をお願いします」）、対応漏れを防げます。

---

## レビュー運用のベストプラクティス

### 推奨ワークフロー

1. **タスク作成時**: 必要に応じてレビュアーを指名する
2. **作業完了時**: ボールを `client` に変更し、レビュー待ち状態にする
3. **レビュー実施**: レビュアーが確認し、承認または変更依頼を行う
4. **修正対応**: 変更依頼があれば修正し、再提出する
5. **完了**: 全レビュアーの承認が揃えばレビュー完了

### 注意点

- 必須レビュアーが不在の場合、レビューが滞る可能性があります。代替レビュアーの設定を検討してください
- 仕様決定（spec タスク）のレビューは、会議と組み合わせることで監査証跡がより強固になります
- レビューコメントは具体的かつ建設的に記載してください
