# レビュー（Client / 社内）仕様メモ（確定した方向性）

## ゴール
- クライアントが「今日どれをチェックすればいいか」明確にする。
- “誰がレビューしたか”の証拠（ログ）を残す。
- 指名レビュアー（必須）と、任意レビュー（自由参加）の両立。

## 方式（あなたの最終指示に沿う）
- 基本は **必須レビュアー方式**（指名された人が完了しない限り完了扱いにならない）。
- ただし「指名なし（誰でもチェックOK）」も許容（混在OK）。

## 再レビュー（差し戻し）
- 差し戻し後も、すでに通ったチェック項目は“維持”してコストを下げる（ゼロからやり直し禁止）。
- つまり「未完了になった部分だけ追加でチェックさせる」。

## 画面（クライアント専用）
- クライアントはログイン前提。
- クライアントモードに “レビュー専用リスト” を持つ（今日チェック / 期限切れ / すべて 等）。
- タスククリックで右ペインに詳細（読む＆コメント＆チェック完了）を出す。

## acceptance-tests

以下は MVP の受け入れテスト（AT-001〜AT-012）。実装完了条件は **全てチェックが通ること**。

### AT-001 会議作成（参加者必須）
- [ ] クライアント参加者0名では保存できない（エラー表示）
- [ ] 1名以上で保存でき、会議一覧に `planned` で出る

### AT-002 会議開始前は決定/承認できない
- [ ] `planned` では「決定する/承認する」が無効（またはガード）
- [ ] 「会議開始」で `in_progress` になり操作可能になる

### AT-003 会議終了通知は1回だけ（冪等）
- [ ] 「会議終了」で通知が生成される
- [ ] 再度終了操作しても通知は増えない（dedupe_key）

### AT-004 会議終了通知の内容（決定/未決抽出と並び）
- [ ] 決定件数・未決件数が一致
- [ ] 未決は期限が近い順、期限なしは最後
- [ ] `ball=client` の未決が優先的に上に出る

### AT-005 議事録MD A方式：SPEC行タスク化＆重複防止
- [ ] `- [ ] SPEC(/spec/...#...): ...` から `type=spec` タスクが生成される
- [ ] 行末に `<!--task:tXXX-->` が付く
- [ ] 再タスク化しても重複生成されない

### AT-006 会議内決定：SPECをdecidedにするログ
- [ ] `spec_decided`（同等）イベントが残る
- [ ] `payload.evidence='meeting'` / `meeting_id` が入る
- [ ] 決定内容が空ならdecidedにできない

### AT-007 会議外「クライアント確定として登録」の必須入力
- [ ] ON時、確認相手・根拠・決定内容が必須
- [ ] 入力すると `on_behalf_of=client` のイベントが残る

### AT-008 入力者と意思決定者の分離（監査）
- [ ] `actor_id=入力者（社内）`
- [ ] `payload.on_behalf_of='client'`
- [ ] `payload.client_confirmed_by=選択したクライアント`
- [ ] 上記が混ざらずに保存される

### AT-009 decided → implemented（2クリック導線）
- [ ] 1回目で `spec_path` を開く（新タブ）
- [ ] 2回目（10分以内）で `implemented` になる
- [ ] `spec_implemented` イベントが残る
- [ ] `spec_path` 空なら押せない

### AT-010 クライアントダッシュボード：未決の優先表示
- [ ] `ball=client` 未決＋review未承認が上位に出る
- [ ] 期限順、期限なしは最後
- [ ] `ball=internal` はクライアントの「要対応」上位に出ない

### AT-011 通知の受信者（参加者＋担当者）
- [ ] 会議終了通知が **会議参加者全員** に届く
- [ ] 参加していないが未決タスクの担当者にも届く
- [ ] クライアントにはクライアント向け文面（余計な社内情報なし）

### AT-012 DB制約：SPECタスクの必須条件
- [ ] `type='spec'` のとき `spec_path` が必須（空で保存不可）
- [ ] `type='spec'` のとき `decision_state` が必須（nullで保存不可）
- [ ] `spec_path` は `/spec/` かつ `#anchor` を含む形式（CHECKで落ちる）
