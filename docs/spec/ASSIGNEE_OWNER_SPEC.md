# タスク担当者・責任者 要件定義書

> **バージョン**: 1.0
> **作成日**: 2026-02-03
> **ステータス**: 承認待ち

---

## 1. 概要

### 1.1 目的
タスクの「担当者」と「責任者」の役割を明確化し、運用の柔軟性とシンプルさを両立する。

### 1.2 背景
- 現状の「オーナー」という名称がわかりづらい
- 担当者がボールの所在と連動していない
- プロジェクトによって責任者欄の必要性が異なる

---

## 2. 用語定義

| 用語 | 定義 | 人数 |
|------|------|------|
| **ボール (ball)** | 次に動くべき側（`client` / `internal`） | - |
| **担当者 (assignee)** | 今アクションすべき人 | 1人 |
| **責任者 (owners)** | 意思決定者・通知を受ける関係者 | 複数可 |

---

## 3. 機能要件

### 3.1 担当者（assignee）

#### FR-ASN-001: ボール連動の担当者選択
- ボールが `internal` の場合：社内メンバーのみ選択可能
- ボールが `client` の場合：社内メンバー **または** クライアントメンバーを選択可能

#### FR-ASN-002: 担当者は1人のみ
- 担当者は常に1人のみ設定可能
- 複数担当者は対象外（責任者で代替）

#### FR-ASN-003: ボール切り替え時の動作
- ボールを `client` → `internal` に切り替えた際、担当者がクライアントの場合：
  - 担当者を社内メンバーに変更するよう促す（警告表示）
  - 強制クリアはしない（ユーザー判断に委ねる）

---

### 3.2 責任者（owners）

#### FR-OWN-001: ラベル変更
- 「オーナー」→「責任者」に名称変更
- UIラベル、ヘルプテキストすべて統一

#### FR-OWN-002: 表示/非表示設定
- 責任者欄の表示/非表示をスペース単位で設定可能

| 設定レベル | 設定項目 | デフォルト値 |
|------------|----------|-------------|
| 組織 | `owner_field_default` | `off` |
| スペース | `owner_field_enabled` | `null`（組織設定に従う） |

#### FR-OWN-003: 非表示時のデータ保持
- 非表示設定でも既存データは保持
- 通知ルールは引き続き動作
- 再表示時にデータが復元される

#### FR-OWN-004: 責任者の種類
- **社内側責任者**: 社内メンバーから複数選択可
- **クライアント側責任者**: クライアントメンバーから複数選択可

---

### 3.3 クライアントダッシュボード表示

#### FR-DSH-001: 表示条件
- `ball = 'client'` のタスクを表示
- 担当者が誰であるかは表示条件に**影響しない**

#### FR-DSH-002: 優先順位
1. `ball = 'client'` かつ未完了
2. 期限が近い順

---

## 4. 非機能要件

### NFR-001: 後方互換性
- 既存データの担当者・責任者は保持
- 設定追加後も既存動作に影響なし

### NFR-002: パフォーマンス
- 担当者/責任者の取得は既存RPC内で完結
- 追加クエリ不要

---

## 5. UI設計

### 5.1 タスク詳細（Inspector）

```
┌─────────────────────────────────┐
│ タスク詳細                    × │
├─────────────────────────────────┤
│ タスク名                        │
│                                 │
│ ステータス: [検討中 ▼]          │
│                                 │
│ ボール: [社内] [→クライアント]  │
│                                 │
│ マイルストーン: [フェーズ1 ▼]   │
│                                 │
│ 担当者: [高木祐介 ▼]            │  ← 1人のみ
│   ※ボール=clientの場合は        │
│     クライアントも選択可         │
│                                 │
│ ─── 以下は設定ONの場合のみ ───  │
│                                 │
│ 責任者:              [編集]     │
│   クライアント: 田中様, 鈴木様  │
│   社内: 高木祐介                │
│                                 │
│ 期限: [2024/02/15]              │
│                                 │
│ 説明: ...                       │
└─────────────────────────────────┘
```

### 5.2 スペース設定

```
┌─────────────────────────────────┐
│ スペース設定 > タスク項目       │
├─────────────────────────────────┤
│                                 │
│ 責任者欄の表示                  │
│ ┌─────────────────────────────┐ │
│ │ ○ 組織設定に従う (OFF)      │ │
│ │ ○ 表示する                  │ │
│ │ ● 表示しない                │ │
│ └─────────────────────────────┘ │
│                                 │
│ ℹ️ 非表示でも既存データと       │
│    通知は保持されます           │
│                                 │
└─────────────────────────────────┘
```

---

## 6. データモデル

### 6.1 既存テーブル（変更なし）

```sql
-- tasks テーブル
tasks.assignee_id  -- UUID, nullable, 1人のみ

-- task_owners テーブル
task_owners.user_id
task_owners.side   -- 'client' | 'internal'
```

### 6.2 新規カラム

```sql
-- organizations テーブルに追加
ALTER TABLE organizations
ADD COLUMN owner_field_default boolean NOT NULL DEFAULT false;

-- spaces テーブルに追加
ALTER TABLE spaces
ADD COLUMN owner_field_enabled boolean DEFAULT NULL;
-- NULL = 組織設定に従う, true = 表示, false = 非表示
```

---

## 7. API変更

### 7.1 担当者選択候補の取得

```typescript
// useSpaceMembers フックの拡張
// ball が 'client' の場合、クライアントメンバーも返す
function getAssignableMembersForTask(ball: 'client' | 'internal') {
  if (ball === 'client') {
    return [...internalMembers, ...clientMembers]
  }
  return internalMembers
}
```

### 7.2 責任者欄表示判定

```typescript
// スペース設定を取得して判定
function shouldShowOwnerField(space: Space, org: Organization): boolean {
  if (space.owner_field_enabled !== null) {
    return space.owner_field_enabled
  }
  return org.owner_field_default
}
```

---

## 8. 実装優先順位

| 優先度 | 項目 | 工数目安 |
|--------|------|----------|
| P0 | FR-OWN-001: ラベル変更（オーナー→責任者） | 0.5h |
| P1 | FR-ASN-001: ボール連動の担当者選択 | 2h |
| P2 | FR-OWN-002: 表示/非表示設定 | 3h |
| P3 | FR-ASN-003: ボール切り替え時の警告 | 1h |

---

## 9. テストケース

### TC-001: 担当者選択（ボール=internal）
- [ ] 社内メンバーのみ選択肢に表示される
- [ ] クライアントメンバーは選択肢に表示されない

### TC-002: 担当者選択（ボール=client）
- [ ] 社内メンバーが選択肢に表示される
- [ ] クライアントメンバーも選択肢に表示される

### TC-003: ボール切り替え時
- [ ] client→internal切り替え時、担当者がクライアントなら警告表示
- [ ] 警告を無視して切り替え可能

### TC-004: 責任者欄の表示/非表示
- [ ] スペース設定で「表示しない」にすると責任者欄が非表示
- [ ] 非表示でも既存データは保持される
- [ ] 再表示時にデータが表示される

### TC-005: クライアントダッシュボード
- [ ] ball=clientのタスクが表示される
- [ ] 担当者が社内でもball=clientなら表示される

---

## 10. 承認

| 役割 | 名前 | 日付 | 署名 |
|------|------|------|------|
| プロダクトオーナー | | | |
| テックリード | | | |

---

## 変更履歴

| バージョン | 日付 | 変更者 | 変更内容 |
|------------|------|--------|----------|
| 1.0 | 2026-02-03 | Claude | 初版作成 |
