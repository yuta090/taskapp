# サブタスク（親子タスク）階層仕様

> **Version**: 1.0
> **Last Updated**: 2026-02-15
> **DDL**: `docs/db/DDL_v0.6_subtasks.sql`
> **Status**: 実装済み

---

## 1. 概要

タスクに1段階の親子関係を導入する。親タスクは作業の大分類、子タスクは具体的な作業項目として機能する。ガントチャートでは親タスクのサマリーバーが子タスクの日付範囲を自動集計して表示する。

### 設計原則

- **1段階のみ**: 孫タスク（深いネスト）は禁止
- **独立性**: ステータス・ボール・担当者は親子で独立管理
- **サマリー自動集計**: 親のガントバーは子の日付範囲から算出（読み取り専用）
- **同一スペース制約**: 親と子は同じ `space_id` に属すること

---

## 2. データモデル

### 2.1 カラム追加

```sql
ALTER TABLE tasks
  ADD COLUMN parent_task_id UUID REFERENCES tasks(id) ON DELETE SET NULL;
```

| カラム | 型 | 制約 | 説明 |
|--------|----|----|------|
| `parent_task_id` | `UUID` | FK → `tasks.id`, nullable | 親タスクのID。NULLならトップレベルタスク |

### 2.2 DB制約

| 制約 | 種別 | 内容 |
|------|------|------|
| `chk_no_self_parent` | CHECK | `parent_task_id != id`（自己参照禁止） |
| `trg_prevent_invalid_parent_task` | TRIGGER | 下記3つを検証 |

**トリガーの検証内容:**

1. **深いネスト禁止**: 指定された親タスクが既に子タスク（`parent_task_id IS NOT NULL`）でないこと
2. **親の子化禁止**: 自身が既に他タスクの親（`parent_task_id = NEW.id` のタスクが存在）でないこと
3. **同一スペース**: 親タスクの `space_id` と子タスクの `space_id` が一致すること

### 2.3 削除時の挙動

```
ON DELETE SET NULL
```

親タスクが削除されると、子タスクの `parent_task_id` が NULL になり、トップレベルタスクに昇格する。

---

## 3. 属性の独立性ルール

| 属性 | 親子連動 | 説明 |
|------|----------|------|
| `status` | 独立 | 親・子で別々に管理。親を完了にしても子は変わらない |
| `ball` | 独立 | ボール所有は個別に切り替え |
| `assignee_id` | 独立 | 担当者は個別に設定 |
| `milestone_id` | 独立（※表示時は継承） | DB上は個別だが、ガントのグループ表示では子は親のマイルストーンに従う |
| `start_date` / `due_date` | 独立 | 親自身の日付と子の日付は別管理。サマリーバーは子のみから集計 |
| `priority` | 独立 | 優先度は個別に設定 |

---

## 4. ガントチャート表示

### 4.1 サマリーバー

親タスクには通常のタスクバーではなく **サマリーバー** を表示する。

- **計算**: `min(children.start_date)` 〜 `max(children.due_date)`
- **親自身の日付は含めない**: サマリーバーは純粋に子タスクの範囲を反映
- **表示**: 薄いインジゴ色の細いバー（6px高）+ 両端にキャップ
- **操作**: ドラッグ不可（読み取り専用）
- **ホバー**: 日付範囲のツールチップを表示

### 4.2 子タスクバー

- 通常のタスクバーと同じ表示・操作
- ドラッグでリサイズ可能（`onDateChange` が渡される）
- ball に応じた色分け

### 4.3 階層表示

| 要素 | 説明 |
|------|------|
| **折りたたみ** | 親タスクの `▶`/`▼` トグルで子の表示/非表示を切り替え |
| **インデント** | 子タスクは親より1段深くインデント（+16px） |
| **子タスク数バッジ** | 親タスクのサイドバーに子タスク数を表示 |
| **フォント** | 親タスク名は `font-weight: 500` |

### 4.4 マイルストーングループ表示

マイルストーン別グループ表示時の親子タスクの扱い:

- **子タスクは親のマイルストーングループに配置される**（表示上の継承）
- 子タスク自身の `milestone_id` が親と異なっていても、ガント上では親と同じグループに表示
- これにより、親と子が別グループに分断されて孤児になる問題を回避

### 4.5 子タスクの期日が未設定の場合

- サマリーバーは非表示
- 代わりに「子タスクの期日未設定」テキストを表示

---

## 5. UI（TaskInspector）

### 5.1 親タスク選択

- ドロップダウンで親タスクを選択
- 選択肢は `getEligibleParents()` でフィルタ: `parent_task_id` が NULL のタスクのみ
- 自分自身は選択肢から除外

### 5.2 子タスク一覧

- 親タスクの Inspector に子タスク一覧を表示
- 各子タスクの ball インジケーター（色）とタイトルを表示
- 完了タスクは打ち消し線 + グレー表示

---

## 6. バリデーション（アプリ層）

`useTasks` フック内の `validateParentTask()` で以下をチェック:

| チェック | エラーメッセージ |
|----------|------------------|
| 自己参照 | 「タスクを自分自身の親に設定することはできません」 |
| 別スペース | 「親タスクは同じスペース内である必要があります」 |
| 親が子タスク | 「子タスクを親に設定することはできません（階層は1段階まで）」 |
| 自身が親 | 「子タスクを持つタスクを別タスクの子にすることはできません」 |

**二重防御**: アプリ層チェックとDB層トリガーの両方で制約を保証。

---

## 7. 実装ファイル

| ファイル | 役割 |
|----------|------|
| `docs/db/DDL_v0.6_subtasks.sql` | スキーマ定義（カラム・制約・トリガー） |
| `src/lib/gantt/treeUtils.ts` | ツリー構築・サマリー日付計算・親候補フィルタ |
| `src/components/gantt/GanttChart.tsx` | ガントチャート本体（階層表示・折りたたみ・MS継承） |
| `src/components/gantt/GanttRow.tsx` | 行描画（サマリーバー・子バー・リサイズ） |
| `src/lib/hooks/useTasks.ts` | CRUD + バリデーション |
| `src/components/task/TaskInspector.tsx` | 親タスク選択・子タスク一覧 |

---

## 8. 設計判断ログ

| # | 判断 | 理由 |
|---|------|------|
| D1 | 1段階制限 | UIの複雑化を避け、プロジェクト管理の実用上2段で十分 |
| D2 | DB層トリガーで制約保証 | CHECK制約では行間の関係を検証できないため |
| D3 | サマリーバーは子のみ集計 | 親自身の日付を含めるとサマリーの意味が不明確になるため |
| D4 | マイルストーンは表示時に親を継承 | DB上の独立性を保ちつつ、ガントの視覚的整合性を確保 |
| D5 | ON DELETE SET NULL | 親削除時に子も消えるのは危険。トップレベルに昇格が安全 |
| D6 | 属性の独立性 | 連動させると状態管理が複雑化し、予期せぬ副作用が生じるため |
