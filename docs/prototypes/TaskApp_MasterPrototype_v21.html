<!DOCTYPE html>
<html lang="ja" class="antialiased">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Task App - Master Prototype v12</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'Noto Sans JP', 'sans-serif'] },
          fontSize: { '2xs': '10px', 'xs': '12px', 'sm': '13px', 'base': '14px', 'lg': '16px' },
          colors: {
            gray: { 25: '#FCFCFD', 50: '#F9FAFB', 100: '#F3F4F6', 200: '#E5E7EB', 300: '#D1D5DB', 400: '#9CA3AF', 500: '#6B7280', 600: '#4B5563', 700: '#374151', 800: '#1F2937', 900: '#111827', 950: '#0B0F19' },
            amber: { 50: '#FFFBEB', 100: '#FEF3C7', 200: '#FDE68A', 400: '#FBBF24', 500: '#F59E0B', 600: '#D97706' },
            indigo: { 500: '#6366F1', 600: '#4F46E5' },
            red: { 50: '#FEF2F2', 100: '#FEE2E2', 500: '#EF4444', 600: '#DC2626' },
            blue: { 50: '#EFF6FF', 100: '#DBEAFE', 600: '#2563EB' }
          },
          boxShadow: {
            'subtle': '0 1px 2px 0 rgba(0, 0, 0, 0.05)',
            'pane': '-1px 0 0 0 #E5E7EB',
            'popover': '0 4px 12px -2px rgba(0, 0, 0, 0.12), 0 0 0 1px rgba(0,0,0,0.05)',
            'modal': '0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)'
          }
        }
      }
    }
  </script>
  <style>
    body { font-feature-settings: "cv02", "cv03", "cv04", "cv11"; letter-spacing: -0.01em; }
    .hide-scrollbar::-webkit-scrollbar { display: none; }

    /* 3-pane: Inspector must resize, never overlay */
    #inspector { width: 0; overflow: hidden; transition: width 150ms ease-out; }
    #inspector.open { width: 400px; border-left: 1px solid #E5E7EB; }

    

        /* Wide-screen readability: constrain & slightly left-shift the main content (NOT true center) */
        .content-wrap { max-width: 1180px; margin-left: auto; margin-right: auto; width: 100%; }
        @media (min-width: 1700px) {
            .content-wrap { transform: translateX(-72px); }
        }
        @media (max-width: 1280px) {
            .content-wrap { transform: none; max-width: none; }
        }
/* List density: 1 row = 1 info, 32-40px */
    .row-h { height: 40px; }
    .task-row:hover .row-actions { display: flex; }
    .task-row:hover .row-meta { display: none; }

    /* Popover */
    .popover { box-shadow: 0 4px 12px -2px rgba(0, 0, 0, 0.12), 0 0 0 1px rgba(0,0,0,0.05); }

    /* Missing alert */
    @keyframes slideDown { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .missing-alert { animation: slideDown 0.2s ease-out forwards; }
  
        @media (min-width: 1920px) {
          #inspector.open { width: 440px; }
        }
        @media (min-width: 2560px) {
          #content-wrap > div { max-width: 1600px; }
          #inspector.open { width: 480px; }
        }
</style>
</head>

<body class="bg-white text-gray-900 h-screen overflow-hidden font-sans text-sm flex">


    <!-- DEBUG NAV -->
    <div class="fixed bottom-4 left-4 z-50 bg-gray-900 text-white px-2 py-1 rounded shadow-lg text-2xs flex gap-2 opacity-30 hover:opacity-100 transition-opacity">
        <button onclick="switchAppMode('internal')" class="hover:underline font-bold">開発画面</button>
        <span class="opacity-40">|</span>
        <button onclick="switchAppMode('client')" class="hover:underline font-bold">顧客レビュー</button>
    </div>

  <!-- APP SHELL -->
  <div id="app-internal" class="flex w-full h-full">

    <!-- 1) LEFT NAV -->
    <aside class="w-[240px] bg-[#F7F8F9] border-r border-gray-200 flex flex-col flex-shrink-0 select-none z-20">
      <!-- Workspace + Quick Create -->
      <div class="h-12 flex items-center px-3 gap-2 mt-1">
        <div class="flex items-center gap-2 px-2 py-1 rounded hover:bg-gray-200/60 cursor-pointer flex-1 transition-colors group relative">
          <div class="w-4 h-4 bg-orange-600 rounded flex items-center justify-center text-white text-2xs font-bold shadow-sm">TA</div>
          <span class="font-medium text-gray-900 truncate">株式会社アトラス</span>
          <i class="ph-bold ph-caret-down text-gray-400 text-2xs group-hover:text-gray-600"></i>
        </div>
        <button onclick="openCreateSheet()" class="p-1.5 text-gray-500 hover:text-gray-900 hover:bg-gray-200/60 rounded transition-colors" title="新規作成 (C)">
          <i class="ph-bold ph-pencil-simple-line text-lg"></i>
        </button>
                <button onclick="switchAppMode('client')" class="p-1.5 text-gray-500 hover:text-gray-900 hover:bg-gray-200/60 rounded transition-colors" title="クライアント表示"><i class="ph-bold ph-eye text-lg"></i></button>
      </div>

      <!-- Nav Items -->
      <div class="flex-1 overflow-y-auto px-2 space-y-6 pt-2">
        <!-- Personal -->
        <div class="space-y-0.5">
          <div id="nav-inbox" onclick="switchView('inbox')" class="px-2 py-1.5 text-gray-900 bg-gray-200/60 rounded cursor-pointer flex items-center gap-2 font-medium group transition-colors">
            <i class="ph ph-tray text-lg text-gray-500 group-hover:text-gray-900"></i> 受信トレイ
            <span id="badge-inbox" class="ml-auto text-2xs px-1.5 py-0.5 rounded bg-gray-900 text-white">3</span>
          </div>
          <div id="nav-personal" onclick="switchView('my')" class="px-2 py-1.5 text-gray-600 hover:bg-gray-200/50 rounded cursor-pointer flex items-center gap-2 group transition-colors">
            <i class="ph ph-target text-lg text-gray-500 group-hover:text-gray-900"></i> 自分の課題
          </div>
        </div>

        <!-- Team / Project -->
        <div>
          <div class="px-2 text-2xs font-medium text-gray-500 mb-1 flex items-center justify-between">
            <span>チーム</span>
          </div>

          <div class="space-y-0.5">
            <div onclick="switchSpace('space_web')" id="nav-team-root" class="px-2 py-1.5 text-gray-600 hover:bg-gray-200/50 rounded cursor-pointer flex items-center gap-2 group">
              <div class="w-4 h-4 rounded bg-indigo-600 text-white flex items-center justify-center text-2xs shadow-sm"><i class="ph-fill ph-planet"></i></div>
              <span class="truncate">Webリニューアル</span>
              <i class="ph-fill ph-caret-down text-[8px] ml-auto text-gray-400"></i>
            </div>

            <div class="pl-2 mt-0.5 space-y-0.5 border-l border-gray-200 ml-4">
              <div onclick="setTaskCategoryFilter('all')" id="menu-tasks" class="px-2 py-1 text-gray-500 hover:text-gray-900 hover:bg-gray-200/50 rounded cursor-pointer flex items-center gap-2 text-xs">
                <i class="ph ph-copy"></i> 課題
              </div>
<div onclick="switchView('client_wait')" id="menu-client" class="px-2 py-1 text-gray-500 hover:text-gray-900 hover:bg-gray-200/50 rounded cursor-pointer flex items-center gap-2 text-xs">
                <i class="ph ph-chat-circle-text"></i> クライアント確認待ち
              </div>
              <div onclick="switchView('meetings')" id="menu-meetings" class="px-2 py-1 text-gray-500 hover:text-gray-900 hover:bg-gray-200/50 rounded cursor-pointer flex items-center gap-2 text-xs">
                <i class="ph ph-notebook"></i> 議事録
              </div>
              <div onclick="switchView('wiki')" id="menu-wiki" class="px-2 py-1 text-gray-500 hover:text-gray-900 hover:bg-gray-200/50 rounded cursor-pointer flex items-center gap-2 text-xs">
                <i class="ph ph-book-open"></i> Wiki
              </div>
              <div onclick="switchView('views')" id="menu-views" class="px-2 py-1 text-gray-500 hover:text-gray-900 hover:bg-gray-200/50 rounded cursor-pointer flex items-center gap-2 text-xs">
                <i class="ph ph-layers"></i> ビュー
              </div>
            </div>
          </div>
        </div>
      </div>
    </aside>

    <!-- CONTENT WRAPPER (Ultra-wide friendly) -->
    <div id="content-wrap" class="flex-1 min-w-0 flex justify-center">
      <div class="flex w-full max-w-[1440px] min-w-0">

    <!-- 2) MAIN CONTEXT -->
    <main class="flex-1 flex flex-col bg-white min-w-0 relative z-0">

      <!-- HEADER (Dynamic Context) -->
      <header id="global-header" class="h-12 border-b border-gray-100 flex items-center justify-center flex-shrink-0 bg-white z-20">
        <div id="global-header-inner" class="content-wrap flex items-center justify-between"></div>
      </header>

      <!-- VIEW: INBOX (notifications) -->
      <section id="view-inbox" class="flex-1 flex overflow-hidden">
        <div class="flex-1 overflow-y-auto"><div id="inbox-list" class="content-wrap"></div></div>
      </section>

      <!-- VIEW: TASKS (project) -->
      <section id="view-tasks" class="flex-1 overflow-y-auto hidden" aria-label="Tasks">
        <div class="content-wrap"><div id="tasks-list" class="pb-10"></div></div>
      </section>

      <!-- VIEW: CLIENT WAIT -->
      <section id="view-client_wait" class="flex-1 overflow-y-auto hidden" aria-label="Client Wait">
        <div class="content-wrap"><div id="client-list" class="pb-10"></div></div>
      </section>

      <!-- VIEW: MEETINGS -->
      <section id="view-meetings" class="flex-1 overflow-y-auto hidden" aria-label="Meetings">
        <div class="px-5 py-2 text-xs font-medium text-gray-500">議事録一覧</div>
        <div class="content-wrap"><div class="border-t border-gray-100" id="meetings-list"></div></div>
      </section>

      <!-- VIEW: WIKI -->
      <section id="view-wiki" class="flex-1 overflow-y-auto hidden" aria-label="Wiki">
        <div class="px-5 py-2 text-xs font-medium text-gray-500">Wiki</div>
        <div class="content-wrap"><div class="border-t border-gray-100" id="wiki-list"></div></div>
      </section>

      <!-- VIEW: VIEWS -->
      <section id="view-views" class="flex-1 overflow-y-auto hidden" aria-label="Views">
        <div class="px-5 py-2 text-xs font-medium text-gray-500">ビュー</div>
        <div class="content-wrap"><div class="border-t border-gray-100" id="views-list"></div></div>
      </section>

      <!-- VIEW: MY TASKS -->
      <section id="view-my" class="flex-1 overflow-y-auto hidden" aria-label="My Tasks">
        <div class="px-5 py-2 text-xs font-medium text-gray-500">自分の課題</div>
        <div class="content-wrap"><div class="border-t border-gray-100" id="my-list"></div></div>
      </section>

    </main>

    <!-- 3) RIGHT INSPECTOR -->
    <aside id="inspector" class="bg-white flex flex-col flex-shrink-0 h-full z-10 shadow-pane border-l border-gray-200 relative">

      <!-- Inspector: Inbox (triage) -->
      <div id="inspector-inbox" class="h-full flex flex-col hidden w-[400px]">
        <div class="h-12 border-b border-gray-100 flex items-center justify-between px-5 flex-shrink-0 bg-gray-50/50">
          <div id="inbox-inspector-title" class="flex items-center gap-2 text-xs font-semibold text-gray-700"></div>
          <div class="flex gap-1">
            <button class="p-1.5 text-gray-400 hover:text-gray-900 hover:bg-gray-200 rounded transition-colors" title="プロジェクトで開く" onclick="transitionToTaskProjectFromInbox()">
              <i class="ph ph-arrow-square-out text-lg"></i>
            </button>
            <button onclick="closeInspector()" class="p-1.5 rounded hover:bg-gray-200 text-gray-400"><i class="ph ph-x"></i></button>
          </div>
        </div>
        <div class="px-5 py-3 border-b border-gray-100 flex gap-2">
          <button onclick="markInboxRead()" class="flex-1 bg-white border border-gray-200 text-gray-700 hover:bg-gray-50 hover:border-gray-300 text-xs font-medium py-1.5 rounded shadow-sm transition-all">
            <i class="ph ph-check mr-1"></i> 既読
          </button>
          <button class="flex-1 bg-white border border-gray-200 text-gray-700 hover:bg-gray-50 hover:border-gray-300 text-xs font-medium py-1.5 rounded shadow-sm transition-all">
            <i class="ph ph-clock mr-1"></i> スヌーズ
          </button>
        </div>
        <div id="inbox-inspector-body" class="flex-1 overflow-y-auto p-6"></div>
      </div>

      <!-- Inspector: Task (edit body) -->
      <div id="inspector-task" class="h-full flex flex-col hidden w-[400px]">
        <!-- Missing bars injected here -->
        <div id="task-alert-slot"></div>

        <div class="h-12 border-b border-gray-100 flex items-center justify-between px-5 flex-shrink-0">
          <div class="flex items-center gap-2 text-xs text-gray-500"><span id="task-code" class="font-mono"></span> / <span id="task-space"></span></div>
          <button onclick="closeInspector()" class="p-1 rounded hover:bg-gray-100 text-gray-400"><i class="ph ph-x"></i></button>
        </div>

        <div class="flex-1 overflow-y-auto p-6 relative">
          <div class="mb-4">
            <input id="task-title" type="text" class="w-full text-lg font-bold border-none p-0 focus:ring-0 mb-2 rounded hover:bg-gray-50 px-1 -ml-1 transition-colors" />

            <div class="flex flex-wrap gap-2">
              <!-- Status (inline popover demo) -->
              <button onclick="togglePopover('pop-status')" class="px-2 py-1 rounded border border-gray-200 text-xs font-medium hover:bg-gray-50 flex items-center gap-1.5">
                <div id="task-status-dot" class="w-2 h-2 rounded-full flex-shrink-0"></div>
                <span id="task-status-label"></span>
                <i class="ph-bold ph-caret-down text-gray-400"></i>
              </button>

              <!-- Assignee (inline popover) -->
              <button id="btn-assignee" onclick="togglePopover('pop-assignee')" class="px-2 py-1 rounded border border-gray-200 text-xs font-medium hover:bg-gray-50 flex items-center gap-1">
                <i class="ph-fill ph-user"></i>
                <span id="task-assignee-label">未割り当て</span>
                <i class="ph-bold ph-caret-down text-gray-400"></i>
              </button>

              <!-- Due (inline popover) -->
              <button onclick="togglePopover('pop-due')" class="px-2 py-1 rounded border border-gray-200 text-xs font-medium hover:bg-gray-50 flex items-center gap-1">
                <i class="ph ph-calendar-blank"></i>
                <span id="task-due-label">期限なし</span>
                <i class="ph-bold ph-caret-down text-gray-400"></i>
              </button>

              <!-- Publish (Safety confirm) -->
              <button id="btn-publish" onclick="openPublishConfirm()" class="px-2 py-1 rounded border border-amber-200 bg-amber-50 text-amber-700 text-xs font-medium hover:bg-amber-100 flex items-center gap-1 transition-colors hidden">
                <i class="ph-fill ph-eye"></i> 公開中
              </button>
              <button id="btn-unpublished" onclick="openPublishConfirm()" class="px-2 py-1 rounded border border-gray-200 bg-white text-gray-600 text-xs font-medium hover:bg-gray-50 flex items-center gap-1 transition-colors">
                <i class="ph ph-eye-slash"></i> 非公開
              </button>

              <!-- Magic (sparkle) -->
              <button class="ml-auto px-2 py-1 rounded border border-gray-200 text-xs font-medium hover:bg-gray-50 flex items-center gap-1" title="Task Magic">
                <i class="ph ph-sparkle"></i> Magic
              </button>
            </div>
          </div>

          <!-- Assignment audit -->
          <div id="task-audit" class="mb-5 text-xs text-gray-500"></div>


          <!-- Review -->
          <div id="task-review" class="mb-5">
            <div class="flex items-center justify-between mb-2">
              <div class="text-xs font-bold text-gray-400 uppercase">レビュー</div>
              <button onclick="toggleReviewSettings()" class="text-xs font-medium text-gray-500 hover:text-gray-900">設定</button>
            </div>
            <div id="task-review-body" class="space-y-2"></div>
            <div id="review-settings" class="hidden mt-2 p-3 rounded-lg border border-gray-200 bg-gray-50">
              <div class="text-2xs font-bold text-gray-400 uppercase mb-2">必須レビュアー (最大3)</div>
              <div id="reviewer-checkboxes" class="space-y-1"></div>
              <div class="mt-3 pt-3 border-t border-gray-200 flex items-center justify-between">
                <div class="text-xs font-medium text-gray-700">本番スタッフ承認</div>
                <label class="inline-flex items-center cursor-pointer">
                  <input id="staff-approval-toggle" type="checkbox" class="sr-only" onchange="toggleStaffApproval(this.checked)">
                  <div class="relative inline-flex items-center h-5 rounded-full w-9 bg-gray-200 transition-colors">
                    <div class="w-4 h-4 bg-white rounded-full shadow transform translate-x-0.5 transition-transform"></div>
                  </div>
                </label>
              </div>
              <div class="mt-2 text-2xs text-gray-500">※ 完了は「必須レビュアー全員の承認」(＋必要なら本番スタッフ承認) が揃ったときにだけ可能。</div>
            </div>
          </div>

          <!-- Description -->
          <div class="text-xs font-bold text-gray-400 uppercase mb-2">説明</div>
          <textarea id="task-desc" class="w-full border border-gray-200 rounded-lg p-3 text-sm focus:ring-2 focus:ring-indigo-500 outline-none resize-none h-40" placeholder="説明を追加..."></textarea>

          <div class="mt-6 text-xs font-bold text-gray-400 uppercase mb-2">関連</div>
          <div class="text-xs text-gray-500">PRリンク / 関連タスクはこのプロトタイプでは省略</div>

          <!-- Popovers -->
          <div id="pop-status" class="hidden absolute z-30 top-[92px] left-6 w-60 bg-white rounded-lg popover border border-gray-200 p-1">
            <div class="px-2 py-1 text-[10px] font-bold text-gray-400 uppercase">Status</div>
            <button class="w-full text-left px-2 py-1.5 hover:bg-gray-50 rounded text-xs" onclick="setTaskStatus('todo')">未着手</button>
            <button class="w-full text-left px-2 py-1.5 hover:bg-gray-50 rounded text-xs" onclick="setTaskStatus('in_progress')">進行中</button>
            <button class="w-full text-left px-2 py-1.5 hover:bg-gray-50 rounded text-xs" onclick="setTaskStatus('in_review')">レビュー</button>
            <button class="w-full text-left px-2 py-1.5 hover:bg-gray-50 rounded text-xs" onclick="setTaskStatus('done')">完了</button>
          </div>

          <div id="pop-assignee" class="hidden absolute z-30 top-[92px] left-[160px] w-64 bg-white rounded-lg popover border border-gray-200 p-1">
            <div class="px-2 py-1 text-[10px] font-bold text-gray-400 uppercase">Assignee</div>
            <button class="w-full text-left px-2 py-1.5 hover:bg-gray-50 rounded text-xs" onclick="setAssignee(null)">未割り当て</button>
            <button class="w-full text-left px-2 py-1.5 hover:bg-gray-50 rounded text-xs" onclick="setAssignee('yuta')">高橋 (自分)</button>
            <button class="w-full text-left px-2 py-1.5 hover:bg-gray-50 rounded text-xs" onclick="setAssignee('jd')">山田 太郎</button>
            <button class="w-full text-left px-2 py-1.5 hover:bg-gray-50 rounded text-xs" onclick="setAssignee('al')">佐藤 花子</button>
            <div class="px-2 py-1 text-[10px] font-bold text-gray-400 uppercase">Enterで確定 / Escでキャンセル</div>
          </div>

          <div id="pop-due" class="hidden absolute z-30 top-[92px] left-[320px] w-64 bg-white rounded-lg popover border border-gray-200 p-2">
            <div class="text-[10px] font-bold text-gray-400 uppercase mb-2">Due Date</div>
            <input id="due-input" type="date" class="w-full border border-gray-200 rounded px-2 py-1 text-xs" onkeydown="if(event.key==='Enter'){applyDueFromInput();} if(event.key==='Escape'){togglePopover('pop-due', false);}"
            />
            <div class="mt-2 flex justify-between">
              <button class="text-xs text-gray-500 hover:text-gray-900" onclick="clearDue()">クリア</button>
              <button class="text-xs font-semibold text-indigo-600 hover:text-indigo-700" onclick="applyDueFromInput()">適用</button>
            </div>
          </div>

        </div>
      </div>

    </aside>

    </div>
  </div>

  </div>

  <!-- MODAL: Publish Confirm (Safety) -->
  <div id="modal-publish-confirm" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden items-center justify-center" onclick="if(event.target===this) closePublishConfirm()">
    <div class="bg-white w-full max-w-md rounded-xl shadow-modal overflow-hidden p-6 ring-1 ring-gray-200">
      <div class="flex items-center gap-3 mb-4 text-amber-600">
        <div class="w-10 h-10 rounded-full bg-amber-100 flex items-center justify-center"><i class="ph-fill ph-eye text-xl"></i></div>
        <h3 class="text-lg font-bold text-gray-900">公開設定の変更</h3>
      </div>
      <p class="text-sm text-gray-600 mb-6">
        公開すると、クライアントポータルで閲覧可能になります。<br>
        <strong>内部情報が含まれていないことを確認してください。</strong>
      </p>
      <div id="publish-preview" class="bg-gray-50 p-3 rounded border border-gray-200 mb-6 text-xs text-gray-500"></div>
      <div class="flex justify-end gap-3">
        <button onclick="closePublishConfirm()" class="px-4 py-2 text-sm font-medium text-gray-600 hover:bg-gray-100 rounded">キャンセル</button>
        <button onclick="togglePublishNow()" class="px-4 py-2 text-sm font-bold text-white bg-amber-600 hover:bg-amber-700 rounded shadow-sm">確定</button>
      </div>
    </div>
  </div>

  <!-- CREATE SHEET (Create only) -->
  <div id="sheet-create" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-50 hidden items-start justify-center pt-16" onclick="if(event.target===this) closeCreateSheet()">
    <div class="bg-white w-full max-w-3xl rounded-xl shadow-modal overflow-hidden ring-1 ring-gray-200">
      <div class="flex items-center justify-between px-4 py-3 border-b border-gray-100">
        <div class="flex items-center gap-2 text-xs text-gray-500">
          <span id="create-context" class="bg-gray-100 px-1.5 py-0.5 rounded text-gray-600 font-medium flex items-center gap-1">
            <i class="ph-fill ph-planet text-indigo-500"></i> Webリニューアル
          </span>
          <i class="ph-bold ph-caret-right text-gray-300"></i>
          <span>新規作成</span>
        </div>
        <button onclick="closeCreateSheet()" class="text-gray-400 hover:text-gray-900"><i class="ph ph-x"></i></button>
      </div>

      <div class="p-6">
        <input id="create-title" type="text" placeholder="タイトルを入力..." class="w-full text-2xl font-semibold border-none outline-none placeholder-gray-300 mb-6" />

        <!-- Bottom Property Bar: Category + optional props -->
        <div class="flex items-center gap-2 flex-wrap relative">
          <button id="btn-category" onclick="togglePopover('menu-cat')" class="flex items-center gap-2 px-2 py-1 rounded border border-gray-200 bg-gray-50 text-gray-900 font-bold text-xs relative">
            <i id="icon-cat" class="ph-fill ph-check-circle text-indigo-600"></i>
            <span id="label-cat">タスク</span>
            <i class="ph-bold ph-caret-down text-gray-400"></i>
          </button>

          <div class="w-px h-4 bg-gray-200 mx-1"></div>

          <button onclick="togglePopover('create-pop-assignee')" class="px-2 py-1 rounded border border-transparent hover:bg-gray-100 hover:border-gray-200 text-xs font-medium text-gray-600 hover:text-gray-900 transition-colors">
            <i class="ph ph-user-circle"></i> 担当者 (推奨)
          </button>
          <button onclick="togglePopover('create-pop-due')" class="px-2 py-1 rounded border border-transparent hover:bg-gray-100 hover:border-gray-200 text-xs font-medium text-gray-600 hover:text-gray-900 transition-colors">
            <i class="ph ph-calendar-blank"></i> 期限
          </button>
          <button class="px-2 py-1 rounded border border-transparent hover:bg-gray-100 hover:border-gray-200 text-xs font-medium text-gray-600 hover:text-gray-900 transition-colors">
            <i class="ph ph-flag"></i> 優先度
          </button>

          <!-- Category dropdown -->
          <div id="menu-cat" class="hidden absolute top-8 left-0 w-52 bg-white rounded-lg popover border border-gray-200 z-50 p-1 text-left">
            <div class="px-2 py-1 text-[10px] font-bold text-gray-400 uppercase">Category</div>
            <button class="w-full flex items-center gap-2 px-2 py-1.5 hover:bg-gray-50 rounded text-xs font-medium" onclick="setCreateCategory('task')">
              <i class="ph-fill ph-check-circle text-indigo-600"></i> タスク
            </button>
            <button class="w-full flex items-center gap-2 px-2 py-1.5 hover:bg-gray-50 rounded text-xs font-medium" onclick="setCreateCategory('bug')">
              <i class="ph-fill ph-bug text-red-600"></i> バグ
            </button>
            <button class="w-full flex items-center gap-2 px-2 py-1.5 hover:bg-gray-50 rounded text-xs font-medium" onclick="setCreateCategory('client')">
              <i class="ph-fill ph-chat-circle-text text-amber-500"></i> クライアント要確認
            </button>
          </div>

          <!-- Create assignee popover -->
          <div id="create-pop-assignee" class="hidden absolute top-8 left-[120px] w-56 bg-white rounded-lg popover border border-gray-200 z-50 p-1">
            <div class="px-2 py-1 text-[10px] font-bold text-gray-400 uppercase">Assignee</div>
            <button class="w-full text-left px-2 py-1.5 hover:bg-gray-50 rounded text-xs" onclick="setCreateAssignee(null)">未割り当て</button>
            <button class="w-full text-left px-2 py-1.5 hover:bg-gray-50 rounded text-xs" onclick="setCreateAssignee('yuta')">高橋 (自分)</button>
            <button class="w-full text-left px-2 py-1.5 hover:bg-gray-50 rounded text-xs" onclick="setCreateAssignee('jd')">山田 太郎</button>
            <button class="w-full text-left px-2 py-1.5 hover:bg-gray-50 rounded text-xs" onclick="setCreateAssignee('al')">佐藤 花子</button>
          </div>

          <!-- Create due popover -->
          <div id="create-pop-due" class="hidden absolute top-8 left-[260px] w-56 bg-white rounded-lg popover border border-gray-200 z-50 p-2">
            <div class="text-[10px] font-bold text-gray-400 uppercase mb-2">Due Date</div>
            <input id="create-due" type="date" class="w-full border border-gray-200 rounded px-2 py-1 text-xs" />
            <div class="mt-2 flex justify-between">
              <button class="text-xs text-gray-500 hover:text-gray-900" onclick="setCreateDue(null)">クリア</button>
              <button class="text-xs font-semibold text-indigo-600 hover:text-indigo-700" onclick="applyCreateDue()">適用</button>
            </div>
          </div>

        </div>
      </div>

      <div class="px-4 py-3 bg-gray-50 border-t border-gray-200 flex items-center justify-between">
        <div class="text-xs text-gray-500">Enterで作成 → Inspectorへ</div>
        <div class="flex items-center gap-3">
          <label class="flex items-center gap-2 cursor-pointer group select-none">
            <input id="create-keep" type="checkbox" class="hidden" />
            <div class="relative inline-flex items-center h-4 rounded-full w-8 bg-gray-200 transition-colors" id="keep-pill">
              <div class="w-3 h-3 bg-white rounded-full shadow transform transition-transform translate-x-0.5" id="keep-dot"></div>
            </div>
            <span class="text-xs font-medium text-gray-500 group-hover:text-gray-700">続けて作成</span>
          </label>
          <button onclick="submitCreate()" class="bg-indigo-600 hover:bg-indigo-700 text-white text-xs font-semibold px-4 py-2 rounded-md shadow-sm transition-all flex items-center gap-2">作成 ↵</button>
        </div>
      </div>

    </div>
  </div>

  <script>
    // ----------------------------------------------------------------------------------
    // In-memory demo data (front-end only)
    // ----------------------------------------------------------------------------------

    const me = { id: 'yuta', name: '高橋', initials: 'YT' };

    const spaces = {
      space_web: { id: 'space_web', name: 'Webリニューアル', org: 'アトラス' },
      personal: { id: 'personal', name: '自分の課題', org: 'アトラス' }
    };

    const users = {
      yuta: { id: 'yuta', name: '高橋', initials: 'YT' },
      jd: { id: 'jd', name: '山田 太郎', initials: 'JD' },
      al: { id: 'al', name: '佐藤 花子', initials: 'AL' }
    };

    const clientUsers = {
      cu1: { id: 'cu1', name: 'クライアントA', initials: 'CA' },
      cu2: { id: 'cu2', name: 'クライアントB', initials: 'CB' },
      cu3: { id: 'cu3', name: 'クライアントC', initials: 'CC' }
    };

    function getPerson(id) {
      return users[id] || clientUsers[id] || { id, name: id, initials: (id || '?').slice(0,2).toUpperCase() };
    }

    const spaceReviewDefaults = {
      space_web: { defaultRequiredReviewers: ['yuta'], maxRequired: 3 }
    };

    const clientSession = { userId: 'cu1' }; // demo: logged-in client user


    const statusMeta = {
      backlog: { label: 'バックログ', dot: 'bg-gray-300' },
      todo: { label: '未着手', dot: 'bg-gray-400' },
      in_progress: { label: '進行中', dot: 'bg-blue-600' },
      in_review: { label: 'レビュー', dot: 'bg-indigo-600' },
      done: { label: '完了', dot: 'bg-gray-800' }
    };

    let state = {
      currentSpaceId: 'space_web',
      currentView: 'inbox',
      taskTab: 'all',
      taskCategoryFilter: 'all',
      inspector: { open: false, kind: null, id: null },
      create: { category: 'task', assignee: null, due: null },
      tasks: [
        {
          id: 't129', short: 129, spaceId: 'space_web',
          title: '認証フローの実装 (GitHub/Google)',
          description: 'Supabase Authの実装…',
          status: 'in_progress',
          category: 'task',
          priority: 3,
          assigneeId: 'jd',
          due: '2026-02-10',
          createdAt: isoNowMinus(60 * 60 * 24),
          createdBy: 'yuta',
          assignedAt: isoNowMinus(60 * 30),
          assignedBy: 'jd',
          review: {
            requiredReviewerIds: ['yuta','cu1'],
            approvals: {},
            staffTestEnabled: false,
            staffApprovedBy: {},
            requestedAt: null,
            requestedBy: null,
            lastFeedback: null
          },
          isClientVisible: true
        },
        {
          id: 't135', short: 135, spaceId: 'space_web',
          title: 'APIエンドポイントの実装 (Posts)',
          description: '',
          status: 'todo',
          category: 'task',
          priority: 1,
          assigneeId: null,
          due: null,
          createdAt: isoNowMinus(60 * 60 * 4),
          createdBy: 'yuta',
          assignedAt: null,
          assignedBy: null,
          isClientVisible: false
        },
        {
          id: 't141', short: 141, spaceId: 'space_web',
          title: 'ヘッダーのレイアウト崩れ',
          description: 'Safariで右ペイン開いた時に崩れる',
          status: 'todo',
          category: 'bug',
          priority: 2,
          assigneeId: 'al',
          due: '2026-02-05',
          createdAt: isoNowMinus(60 * 60 * 8),
          createdBy: 'jd',
          assignedAt: isoNowMinus(60 * 60 * 7),
          assignedBy: 'jd',
          review: {
            requiredReviewerIds: ['yuta'],
            approvals: {},
            staffTestEnabled: false,
            staffApprovedBy: {},
            requestedAt: null,
            requestedBy: null,
            lastFeedback: null
          },
          isClientVisible: false
        },
        {
          id: 't150', short: 150, spaceId: 'space_web',
          title: 'クライアント確認: ヒーロー画像方針',
          description: '素材写真 or イラスト',
          status: 'todo',
          category: 'client',
          priority: 2,
          assigneeId: null,
          due: '2026-02-03',
          createdAt: isoNowMinus(60 * 10),
          createdBy: 'yuta',
          assignedAt: null,
          assignedBy: null,
          isClientVisible: true
        }
      ],
      inbox: [
        {
          id: 'n1',
          type: 'client_reply',
          spaceId: 'space_web',
          taskId: 't150',
          title: '要アクション: ヒーロー画像の方針',
          snippet: 'クライアント: 「素材写真を使いますか？それともイラストにしますか？」',
          statusBadge: '開発者待ち',
          createdAt: isoNowMinus(60 * 10),
          unread: true,
          clientVisible: true
        },
        {
          id: 'n2',
          type: 'assigned',
          spaceId: 'space_web',
          taskId: 't129',
          title: 'TP-129: 認証フローの実装',
          snippet: '山田 太郎があなたを担当者に割り当てました。',
          createdAt: isoNowMinus(60 * 60 * 2),
          unread: true,
          clientVisible: false
        },
        {
          id: 'n3',
          type: 'missing_assignee',
          spaceId: 'space_web',
          taskId: 't135',
          title: '未割り当て: APIエンドポイントの実装',
          snippet: 'あなたが作成したタスクに担当者が設定されていません。',
          createdAt: isoNowMinus(60 * 1),
          unread: true,
          clientVisible: false
        }
      ],
      meetings: [
        { id: 'm1', title: '要件定義MTG (週次)', heldAt: isoNowMinus(60 * 60 * 24 * 2), milestone: 'M1: 基盤構築' },
        { id: 'm2', title: 'デザインレビュー', heldAt: isoNowMinus(60 * 60 * 24 * 5), milestone: 'M1: 基盤構築' }
      ],
      wiki: [
        { id: 'w1', title: '開発環境セットアップ', updated_at: isoNowMinus(60 * 60 * 24 * 3) },
        { id: 'w2', title: 'リリース手順', updated_at: isoNowMinus(60 * 60 * 24 * 7) }
      ],
      views: [
        { id: 'v1', title: '今週の優先度(高)', desc: 'High priority / due within 7 days' },
        { id: 'v2', title: '未割り当て一覧', desc: 'assignee_id is null' }
      ]
    };

    // ----------------------------------------------------------------------------------
    // Header configs
    // ----------------------------------------------------------------------------------

    const headerState = {
      inbox: {
        left: `
          <div class="flex gap-1">
            <button class="px-3 py-1.5 text-xs font-medium text-gray-900 bg-gray-100 rounded-md">重要</button>
            <button class="px-3 py-1.5 text-xs font-medium text-gray-500 hover:text-gray-900">その他</button>
            <button class="px-3 py-1.5 text-xs font-medium text-gray-500 hover:text-gray-900">スヌーズ</button>
          </div>
        `,
        right: `
          <button class="text-gray-500 hover:text-gray-900 text-xs flex items-center gap-1.5 px-2 py-1 rounded hover:bg-gray-100" onclick="markAllRead()">
            <i class="ph ph-check-double text-base"></i> すべて既読にする
          </button>
          <div class="h-4 w-px bg-gray-200"></div>
          <button class="text-xs text-gray-600 hover:text-gray-900 flex items-center gap-1.5 py-1 px-2 hover:bg-gray-50 rounded">
            <i class="ph ph-sliders-horizontal text-base"></i> 表示設定
          </button>
        `
      },
      client_wait: {
        left: `
          <span class="text-gray-500">アトラス</span> <span class="text-gray-300">/</span>
          <span class="font-medium text-gray-900">Webリニューアル</span>
          <div class="ml-3 pl-3 border-l border-gray-200 flex items-center gap-2">
            <span class="text-xs text-gray-500 font-medium">クライアント要確認</span>
          </div>
        `,
        right: `
          <button class="text-xs text-gray-600 hover:text-gray-900 flex items-center gap-1.5 py-1 px-2 hover:bg-gray-50 rounded">
            <i class="ph ph-sliders-horizontal text-base"></i> 表示設定
          </button>
        `
      },
      wiki: {
        left: `
          <span class="text-gray-500">アトラス</span> <span class="text-gray-300">/</span>
          <span class="font-medium text-gray-900">Webリニューアル</span>
          <div class="ml-3 pl-3 border-l border-gray-200 flex items-center gap-2">
            <span class="text-xs text-gray-500 font-medium">Wiki</span>
          </div>
        `,
        right: `
          <button class="text-xs text-gray-600 hover:text-gray-900 flex items-center gap-1.5 py-1 px-2 hover:bg-gray-50 rounded">
            <i class="ph ph-plus text-base"></i> 新規ページ
          </button>
        `
      },
      meetings: {
        left: `
          <span class="text-gray-500">アトラス</span> <span class="text-gray-300">/</span>
          <span class="font-medium text-gray-900">Webリニューアル</span>
          <div class="ml-3 pl-3 border-l border-gray-200 flex items-center gap-2">
            <span class="text-xs text-gray-500 font-medium">議事録</span>
          </div>
        `,
        right: `
          <button class="text-xs text-gray-600 hover:text-gray-900 flex items-center gap-1.5 py-1 px-2 hover:bg-gray-50 rounded">
            <i class="ph ph-upload-simple text-base"></i> 取り込み
          </button>
        `
      }
    };

    function buildTasksHeader() {
      const tab = state.taskTab || 'all';
      const cat = state.taskCategoryFilter || 'all';

      const tabBtn = (key, label) => {
        const active = tab === key;
        return `
          <button
            class="px-3 py-1.5 text-xs font-medium rounded-md transition-colors ${active ? 'bg-gray-100 text-gray-900' : 'text-gray-500 hover:text-gray-900 hover:bg-gray-50'}"
            onclick="setTaskTab('${key}')"
          >${label}</button>
        `;
      };

      const catLabel =
        cat === 'bug' ? 'バグ' :
        cat === 'task' ? '課題' :
        cat === 'client' ? 'クライアント要確認' :
        'すべて';

      const catIcon =
        cat === 'bug' ? 'ph-fill ph-bug text-red-600' :
        cat === 'client' ? 'ph-fill ph-chat-circle-text text-amber-500' :
        'ph-fill ph-check-circle text-indigo-600';

      return {
        left: `
          <div class="flex items-center gap-2">
            <span class="text-gray-500">アトラス</span>
            <span class="text-gray-300">/</span>
            <span class="font-medium text-gray-900">Webリニューアル</span>

            <div class="ml-3 pl-3 border-l border-gray-200 flex items-center gap-1">
              ${tabBtn('all', 'すべての課題')}
              ${tabBtn('active', 'アクティブ')}
              ${tabBtn('backlog', 'バックログ')}
            </div>

            <div class="ml-2 pl-3 border-l border-gray-200 flex items-center relative">
              <button class="px-2.5 py-1.5 text-xs font-medium rounded-md border border-gray-200 hover:bg-gray-50 flex items-center gap-1.5"
                onclick="toggleTaskCategoryMenu(event)">
                <i class="${catIcon}"></i>
                <span>${catLabel}</span>
                <i class="ph-bold ph-caret-down text-gray-400 text-2xs"></i>
              </button>

              <div id="task-cat-menu" class="hidden absolute top-9 left-0 w-56 bg-white rounded-lg shadow-popover border border-gray-200 z-50 p-1 text-left">
                <div class="px-2 py-1 text-[10px] font-bold text-gray-400 uppercase">種別フィルタ</div>
                <div class="flex items-center gap-2 px-2 py-1.5 hover:bg-gray-50 rounded text-xs font-medium cursor-pointer" onclick="setTaskCategoryFilter('all')">
                  <i class="ph-fill ph-funnel text-gray-500"></i> すべて
                </div>
                <div class="flex items-center gap-2 px-2 py-1.5 hover:bg-gray-50 rounded text-xs font-medium cursor-pointer" onclick="setTaskCategoryFilter('task')">
                  <i class="ph-fill ph-check-circle text-indigo-600"></i> 課題
                </div>
                <div class="flex items-center gap-2 px-2 py-1.5 hover:bg-gray-50 rounded text-xs font-medium cursor-pointer" onclick="setTaskCategoryFilter('bug')">
                  <i class="ph-fill ph-bug text-red-600"></i> バグ
                </div>
                <div class="flex items-center gap-2 px-2 py-1.5 hover:bg-gray-50 rounded text-xs font-medium cursor-pointer" onclick="setTaskCategoryFilter('client')">
                  <i class="ph-fill ph-chat-circle-text text-amber-500"></i> クライアント要確認
                </div>
              </div>
            </div>
          </div>
        `,
        right: `
          <button class="text-xs text-gray-600 hover:text-gray-900 flex items-center gap-1.5 py-1 px-2 hover:bg-gray-50 rounded">
            <i class="ph ph-sliders-horizontal text-base"></i> 表示設定
          </button>
        `
      };
    }

    function getHeaderConfig(view) {
      if (view === 'tasks') return buildTasksHeader();
      return headerState[view] || headerState.inbox;
    }

    // ----------------------------------------------------------------------------------
    // Navigation
    // ----------------------------------------------------------------------------------

    function switchSpace(spaceId) {
      state.currentSpaceId = spaceId;
      // default view when switching space
      switchView('tasks');
    }

    function switchView(view) {
      state.currentView = view;

      // Hide all views
      ['view-tasks', 'view-inbox', 'view-client_wait', 'view-wiki', 'view-meetings', 'view-views', 'view-my']
        .forEach(id => {
          const el = document.getElementById(id);
          if (el) el.classList.add('hidden');
        });

      const viewEl = document.getElementById(`view-${view}`);
      if (viewEl) viewEl.classList.remove('hidden');

      // Nav active styling
      const navMap = {
        inbox: 'nav-inbox',
        tasks: 'nav-tasks',
        client_wait: 'nav-client_wait',
        wiki: 'nav-wiki',
        meetings: 'nav-meetings',
        views: 'nav-views',
        my: 'nav-my'
      };

      Object.entries(navMap).forEach(([k, id]) => {
        const el = document.getElementById(id);
        if (!el) return;
        const active = k === view;
        el.className = active
          ? "px-2 py-1.5 text-gray-900 bg-gray-200/60 rounded cursor-pointer flex items-center gap-2 font-medium"
          : "px-2 py-1.5 text-gray-600 hover:bg-gray-200/50 rounded cursor-pointer flex items-center gap-2";
      });

      // Header
      const config = getHeaderConfig(view);
      document.getElementById('global-header-inner').innerHTML =
        `<div class="flex items-center gap-2 text-sm">${config.left}</div><div class="flex items-center gap-3">${config.right}</div>`;

      // Close floating menus when switching
      closeAllPopovers();

      // Re-render lists
      renderAll();
    }

    function closeAllPopovers() {
      ['menu-cat', 'task-cat-menu'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.classList.add('hidden');
      });
    }

    function toggleTaskCategoryMenu(e) {
      e.stopPropagation();
      const el = document.getElementById('task-cat-menu');
      if (!el) return;
      el.classList.toggle('hidden');
    }

    function setTaskTab(tab) {
      state.taskTab = tab;
      // Keep user in tasks view
      if (state.currentView !== 'tasks') state.currentView = 'tasks';
      switchView('tasks');
    }

    function setTaskCategoryFilter(cat) {
      state.taskCategoryFilter = cat;
      if (state.currentView !== 'tasks') state.currentView = 'tasks';
      switchView('tasks');
    }// ----------------------------------------------------------------------------------
    // Rendering
    // ----------------------------------------------------------------------------------

    function renderAll() {
      renderInbox();
      renderTasksLists();
      renderMeetings();
      renderWiki();
      renderViews();
      renderMyTasks();
      updateInboxBadge();
    }

    function updateInboxBadge() {
      const unread = state.inbox.filter(n => n.unread).length;
      const badge = document.getElementById('badge-inbox');
      if (badge) badge.textContent = String(unread);
    }

    function renderInbox() {
      const root = document.getElementById('inbox-list');
      if (!root) return;

      const items = state.inbox
        .slice()
        .sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));

      root.innerHTML = `
        <div class="px-5 py-2 text-xs font-medium text-gray-500">今日</div>
        ${items.map(n => inboxRow(n)).join('')}
      `;
    }

    function inboxRow(n) {
      const space = spaces[n.spaceId]?.name || 'プロジェクト';
      const time = relativeTime(n.createdAt);

      let icon = '<div class="w-5 h-5 rounded bg-blue-100 text-blue-600 flex items-center justify-center text-[10px]"><i class="ph-fill ph-bell"></i></div>';
      if (n.type === 'client_reply') icon = '<div class="w-5 h-5 rounded bg-amber-100 text-amber-600 flex items-center justify-center text-[10px]"><i class="ph-fill ph-chat-circle-text"></i></div>';
      if (n.type === 'missing_assignee') icon = '<div class="w-5 h-5 rounded bg-red-100 text-red-600 flex items-center justify-center text-[10px]"><i class="ph-fill ph-warning"></i></div>';

      const amber = n.clientVisible ? '<i class="ph-fill ph-eye text-amber-500 text-xs" title="顧客に公開中"></i>' : '';
      const badge = n.statusBadge ? `<span class="px-1.5 py-0.5 rounded text-[10px] bg-amber-50 text-amber-700 border border-amber-200">${escapeHtml(n.statusBadge)}</span>` : '';

      return `
        <div class="flex items-start gap-3 px-5 py-3 border-b border-gray-50 hover:bg-gray-50 cursor-pointer group transition-colors relative" onclick="openInboxInspector('${n.id}')">
          <div class="mt-0.5 relative">${icon}</div>
          <div class="flex-1 min-w-0">
            <div class="flex justify-between items-baseline mb-0.5">
              <span class="text-xs text-gray-500 font-medium">${escapeHtml(space)}</span>
              <span class="text-xs text-gray-400 flex-shrink-0">${escapeHtml(time)}</span>
            </div>
            <div class="flex items-center gap-2 text-sm mb-1">
              <span class="font-medium text-gray-900 truncate">${escapeHtml(n.title)}</span>
              ${amber}
              ${badge}
            </div>
            <p class="text-xs text-gray-500 line-clamp-1">${escapeHtml(n.snippet)}</p>
          </div>
          ${n.unread ? '<div class="absolute left-1 top-4 w-1.5 h-1.5 bg-blue-600 rounded-full"></div>' : ''}
        </div>
      `;
    }

    function taskVisibleInTasksView(t) {
      // Tab filter
      const tab = state.taskTab || 'all';
      if (tab === 'active' && (t.status === 'backlog' || t.status === 'done')) return false;
      if (tab === 'backlog' && t.status !== 'backlog') return false;

      // Category filter
      const cat = state.taskCategoryFilter || 'all';
      if (cat !== 'all' && t.category !== cat) return false;

      return true;
    }

    function renderTasksLists() {
      // Tasks view (includes bug/client categories; filter controls live in header)
      renderTaskListInto('tasks-list', taskVisibleInTasksView);

      // Client wait view (quick slice)
      renderTaskListInto('client-list', t => t.category === 'client');
    }

    

    // Collapsible status groups (Linear-like)
    function _collapsedKey(containerId, groupKey) {
      return `${containerId}:${state.currentSpaceId}:${groupKey}`;
    }

    function _loadCollapsedGroups() {
      try {
        return JSON.parse(localStorage.getItem('tp_collapsed_groups') || '{}') || {};
      } catch (e) {
        return {};
      }
    }

    function _saveCollapsedGroups(map) {
      localStorage.setItem('tp_collapsed_groups', JSON.stringify(map || {}));
    }

    function isGroupCollapsed(containerId, groupKey) {
      state._collapsedGroups = state._collapsedGroups || _loadCollapsedGroups();
      return !!state._collapsedGroups[_collapsedKey(containerId, groupKey)];
    }

    function setGroupCollapsed(containerId, groupKey, val) {
      state._collapsedGroups = state._collapsedGroups || _loadCollapsedGroups();
      state._collapsedGroups[_collapsedKey(containerId, groupKey)] = !!val;
      _saveCollapsedGroups(state._collapsedGroups);
    }

    function toggleGroup(containerId, groupKey) {
      setGroupCollapsed(containerId, groupKey, !isGroupCollapsed(containerId, groupKey));
      const pred = (state._lastListPredicates && state._lastListPredicates[containerId]) ? state._lastListPredicates[containerId] : (t => true);
      renderTaskListInto(containerId, pred);
    }
function renderTaskListInto(containerId, predicate) {
      const el = document.getElementById(containerId);
      if (!el) return;

      state._lastListPredicates = state._lastListPredicates || {};
      state._lastListPredicates[containerId] = predicate;

      const all = state.tasks.filter(t => t.spaceId === state.currentSpaceId).filter(predicate);

      const STATUS_LABELS = {
        backlog: 'バックログ',
        todo: '未着手',
        in_progress: '進行中',
        in_review: 'レビュー',
        done: '完了'
      };

      const STATUS_ICONS = {
        backlog: 'ph-archive',
        todo: 'ph-circle',
        in_progress: 'ph-circle-notch',
        in_review: 'ph-eye',
        done: 'ph-check-circle'
      };

      const order = (containerId === 'tasks-list')
        ? (state.taskTab === 'backlog'
            ? ['backlog']
            : (state.taskTab === 'active'
                ? ['todo', 'in_progress', 'in_review']
                : ['todo', 'in_progress', 'in_review', 'backlog', 'done']))
        : ['open', 'waiting_client', 'waiting_dev', 'resolved'];

      // Discussion list uses different renderer
      if (containerId === 'client-list') {
        const items = state.discussionItems.filter(d => d.spaceId === state.currentSpaceId).filter(predicate);
        el.innerHTML = items.length ? items.map(renderDiscussionRow).join('') : `<div class="px-5 py-8 text-xs text-gray-400">表示する項目がありません。</div>`;
        return;
      }

      let html = '';
      for (const statusKey of order) {
        const group = all.filter(t => t.status === statusKey);
        if (group.length === 0) continue;

        const collapsed = isGroupCollapsed(containerId, statusKey);
        const caretIcon = collapsed ? 'ph-caret-right' : 'ph-caret-down';

        html += `
          <div class="status-group" data-status="${statusKey}">
            <div class="sticky top-0 bg-white/95 backdrop-blur z-10 px-5 py-2 flex items-center justify-between border-b border-transparent hover:bg-gray-50 cursor-pointer select-none group" onclick="toggleGroup('${containerId}','${statusKey}')">
              <div class="flex items-center gap-2 min-w-0">
                <i class="ph-bold ${caretIcon} text-2xs text-gray-400"></i>
                <div class="w-4 h-4 rounded flex items-center justify-center">
                  <i class="ph-fill ${STATUS_ICONS[statusKey] || 'ph-circle'} text-xs text-gray-500"></i>
                </div>
                <span class="font-medium text-xs text-gray-900 truncate">${STATUS_LABELS[statusKey] || statusKey}</span>
                <span class="text-gray-400 text-xs">${group.length}</span>
              </div>
              <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                <button class="text-gray-400 hover:text-gray-700 p-1 rounded hover:bg-gray-100" title="このステータスで作成" onclick="event.stopPropagation(); openCreateSheet({status: '${statusKey}'})">
                  <i class="ph-bold ph-plus"></i>
                </button>
              </div>
            </div>
            ${collapsed ? '' : group.map(taskRow).join('')}
          </div>
        `;
      }

      el.innerHTML = html || `<div class="px-5 py-8 text-xs text-gray-400">表示する項目がありません。</div>`;
    }

    function taskRow(t) {
  const statusIcon = t.status === 'in_progress'
    ? '<i class="ph-fill ph-circle-notch"></i>'
    : t.status === 'done'
      ? '<i class="ph-fill ph-check-circle"></i>'
      : '<i class="ph-bold ph-circle"></i>';

  const amber = t.clientVisible ? '<i class="ph-fill ph-eye text-amber-500 text-xs" title="顧客に公開中"></i>' : '';

  const due = t.dueDate
    ? `<span class="w-16 truncate">${escapeHtml(t.dueDate)}</span>`
    : `<span class="w-16 truncate text-gray-300">—</span>`;

  const pri = priorityIcon(t.priority);

  const assignee = t.assigneeId
    ? userPill(t.assigneeId)
    : `
      <div class="relative w-5 h-5 rounded-full bg-gray-100 text-gray-400 text-2xs flex items-center justify-center border border-white">
        <i class="ph-fill ph-user"></i>
        <div class="absolute -top-0.5 -right-0.5 w-2 h-2 bg-red-500 rounded-full ring-2 ring-white" title="未割り当て"></div>
      </div>
    `;

  return `
    <div class="task-row group flex items-center gap-3 px-5 py-2 border-b border-gray-50 hover:bg-gray-50 cursor-pointer h-10 transition-colors" onclick="openTaskInspector('${t.id}')">
      <div class="w-4 h-4 flex-shrink-0 flex items-center justify-center ${t.status === 'in_progress' ? 'text-blue-600' : t.status === 'done' ? 'text-green-600' : 'text-gray-400'} cursor-pointer hover:bg-gray-200 rounded" onclick="event.stopPropagation(); toggleDoneQuick(\'${t.id}\')" title="${escapeHtml(t.status)}">${statusIcon}</div>
      <span class="font-mono text-gray-400 text-xs w-14 flex-shrink-0">${escapeHtml(t.key)}</span>
      <div class="flex-1 min-w-0 flex items-center gap-2">
        <span class="text-sm text-gray-900 font-medium truncate">${categoryIcon(t.category)} ${escapeHtml(t.title)}</span>
        ${amber}
      </div>
      <div class="row-meta flex items-center gap-4 text-xs text-gray-500 flex-shrink-0">
        ${pri}
        ${due}
        ${assignee}
      </div>
      <div class="row-actions hidden items-center gap-1 flex-shrink-0">
        <button class="p-1 text-gray-400 hover:text-amber-600 hover:bg-amber-50 rounded" title="公開設定"><i class="ph ph-eye"></i></button>
      </div>
    </div>
  `;
}

    function categoryIcon(cat) {
      if (cat === 'bug') return '<i class="ph-fill ph-bug text-red-600"></i>';
      if (cat === 'client') return '<i class="ph-fill ph-chat-circle-text text-amber-500"></i>';
      return '<i class="ph-fill ph-circle-notch text-blue-600"></i>';
    }

    function priorityIcon(p) {
  // priority: 0 none, 1 low, 2 medium, 3 high
  if (p === 3) return '<i class="ph-fill ph-flag text-orange-500" title="優先度: 高"></i>';
  if (p === 2) return '<i class="ph-fill ph-flag text-amber-500" title="優先度: 中"></i>';
  if (p === 1) return '<i class="ph-fill ph-flag text-gray-300" title="優先度: 低"></i>';
  return '<i class="ph-fill ph-flag text-gray-200" title="優先度: なし"></i>';
}

function userPill(userId) {
      const u = users[userId];
      if (!u) return '';
      return `<div class="w-5 h-5 rounded-full bg-indigo-100 text-indigo-600 text-2xs flex items-center justify-center border border-white font-medium">${escapeHtml(u.initials)}</div>`;
    }

    function renderMeetings() {
      const root = document.getElementById('meetings-list');
      if (!root) return;
      root.innerHTML = state.meetings.map(m => `
        <div class="flex items-center px-5 py-2 border-b border-gray-50 hover:bg-gray-50 cursor-pointer row-h" onclick="openMeetingInspector('${m.id}')">
          <span class="text-sm text-gray-900 font-medium truncate">${escapeHtml(m.title)}</span>
          <span class="ml-auto text-xs text-gray-400">${escapeHtml(shortDateTime(m.heldAt))}</span>
        </div>
      `).join('');
    }

    function renderWiki() {
      const root = document.getElementById('wiki-list');
      if (!root) return;
      root.innerHTML = state.wiki.map(w => `
        <div class="flex items-center px-5 py-2 border-b border-gray-50 hover:bg-gray-50 cursor-pointer row-h" onclick="openWikiInspector('${w.id}')">
          <span class="text-sm text-gray-900 font-medium truncate">${escapeHtml(w.title)}</span>
          <span class="ml-auto text-xs text-gray-400">更新: ${escapeHtml(relativeTime(w.updated_at))}</span>
        </div>
      `).join('');
    }

    function renderViews() {
      const root = document.getElementById('views-list');
      if (!root) return;
      root.innerHTML = state.views.map(v => `
        <div class="px-5 py-3 border-b border-gray-50 hover:bg-gray-50 cursor-pointer" onclick="applyView('${v.id}')">
          <div class="text-sm font-medium text-gray-900">${escapeHtml(v.title)}</div>
          <div class="text-xs text-gray-500">${escapeHtml(v.desc)}</div>
        </div>
      `).join('');
    }

    function renderMyTasks() {
      const root = document.getElementById('my-list');
      if (!root) return;
      const mine = state.tasks.filter(t => t.assigneeId === me.id);
      root.innerHTML = mine.length
        ? mine.map(t => taskRow(t)).join('')
        : `<div class="px-5 py-6 text-sm text-gray-500">割り当てられた課題はありません。</div>`;
    }

    // ----------------------------------------------------------------------------------
    // Inspector routing (no overlay; resize only)
    // ----------------------------------------------------------------------------------

    function openInspector(kind, id) {
      state.inspector = { open: true, kind, id };
      const inspector = document.getElementById('inspector');
      inspector.classList.add('open');

      // hide all inspector panels
      document.getElementById('inspector-task').classList.add('hidden');
      document.getElementById('inspector-inbox').classList.add('hidden');

      // update URL query (prototype)
      const url = new URL(window.location.href);
      url.searchParams.delete('task');
      url.searchParams.delete('inbox');
      if (kind === 'task') url.searchParams.set('task', id);
      if (kind === 'inbox') url.searchParams.set('inbox', id);
      window.history.replaceState({}, '', url);

      if (kind === 'task') {
        document.getElementById('inspector-task').classList.remove('hidden');
        hydrateTaskInspector(id);
      }
      if (kind === 'inbox') {
        document.getElementById('inspector-inbox').classList.remove('hidden');
        hydrateInboxInspector(id);
      }
    }

    function closeInspector() {
      state.inspector = { open: false, kind: null, id: null };
      document.getElementById('inspector').classList.remove('open');

      ['pop-status','pop-assignee','pop-due'].forEach(pid => togglePopover(pid, false));

      const url = new URL(window.location.href);
      url.searchParams.delete('task');
      url.searchParams.delete('inbox');
      window.history.replaceState({}, '', url);
    }

    function openTaskInspector(taskId) {
      // Toggle behavior: clicking the same row again closes the inspector
      if (state.inspector?.open && state.inspector.kind === 'task' && state.inspector.id === taskId) {
        closeInspector();
        return;
      }
      openInspector('task', taskId);
    }

    function openInboxInspector(inboxId) {
      // Toggle behavior: clicking the same inbox row again closes the inspector
      if (state.inspector?.open && state.inspector.kind === 'inbox' && state.inspector.id === inboxId) {
        closeInspector();
        return;
      }
      openInspector('inbox', inboxId);
    }

    // ----------------------------------------------------------------------------------
    // Task Inspector: bind + missing recovery
    // ----------------------------------------------------------------------------------

    
      

function nowISO() { return new Date().toISOString(); }
function findTask(id){ return state.tasks.find(t => t.id === id); }
function updateTaskById(id, patch){
  const idx = state.tasks.findIndex(t => t.id === id);
  if (idx === -1) return;
  state.tasks[idx] = { ...state.tasks[idx], ...patch, updated_at: nowISO() };
}

function ensureReview(t){
  if(!t.review) t.review = {};
  if(!t.review.approvals) t.review.approvals = {}; // { [userId]: { status:'approved', at, comment? } }
  if(!t.review.requiredReviewerIds) t.review.requiredReviewerIds = [];
  if(!t.review.blockedReviewerIds) t.review.blockedReviewerIds = []; // 再承認が必要な人
  if(!t.review.state) t.review.state = 'idle'; // idle | requested | changes_requested | approved
  if(t.review.staffTestEnabled === undefined) t.review.staffTestEnabled = false;
  if(!t.review.staffApprovedBy) t.review.staffApprovedBy = {}; // { [userId]: {at} }
  return t.review;
}

function requiresReview(t){
  if (t.spaceId === 'space-personal') return false;
  const r = ensureReview(t);
  return (r.requiredReviewerIds?.length || 0) > 0 || !!r.staffTestEnabled;
}

function getRequiredReviewers(t){
          const r = ensureReview(t);
          const ids = r.requiredReviewerIds || [];
          // return reviewer IDs (社内 + クライアント)
          return ids.filter(uid => !!getPerson(uid));
        }

function reviewProgress(t){
  if(!requiresReview(t)) {
    return { required: 0, approved: 0, approvedCount: 0, total: 0, staffRequired: false, staffApproved: false, staffOk: true, isApproved: true };
  }
  const r = ensureReview(t);
  const reqIds = r.requiredReviewerIds||[];
  const total = reqIds.length;

  const approvedCount = reqIds.filter(uid => {
    const a = r.approvals?.[uid];
    const isBlocked = (r.blockedReviewerIds||[]).includes(uid);
    return !!a && a.status === 'approved' && !isBlocked;
  }).length;

  const staffRequired = !!r.staffTestEnabled;
  const staffApproved = staffRequired ? Object.keys(r.staffApprovedBy||{}).length > 0 : false;
  const staffOk = staffRequired ? staffApproved : true;

  const isApproved = (approvedCount >= total) && staffOk;

  return {
    required: total,
    approved: approvedCount,
    approvedCount,
    total,
    staffRequired,
    staffApproved,
    staffOk,
    isApproved
  };
}

function clearReview(t){
  const r = ensureReview(t);
  r.requiredReviewerIds = [];
  r.approvals = {};
  r.blockedReviewerIds = [];
  r.staffTestEnabled = false;
  r.staffApprovedBy = {};
  r.lastFeedback = null;
  r.lastFeedbackBy = null;
  r.lastFeedbackAt = null;
  r.requestedAt = null;
  r.state = 'idle';
}

function requestReview(taskId){
  const t = findTask(taskId); if(!t) return;
  if (!requiresReview(t)) return;
  const r = ensureReview(t);

  // 「差し戻し後に0からやり直し」はコスト高いので approvals は保持。
  // ただし、差し戻しを出した本人は blockedReviewerIds に入れて再承認必須にする（クライアント側でやる）。
  r.requestedAt = nowISO();
  r.state = 'requested';

  t.status = 'in_review';
  t.updated_at = nowISO();

  // 既に条件を満たしているなら即完了もあり得る（主に required 変更時など）
  updateReviewState(t);

  renderAll();
  openInspector('task', taskId);
}

function approveTask(taskId, userId){
  const t = findTask(taskId); if(!t) return;
  if (!requiresReview(t)) return;
  const r = ensureReview(t);

  r.approvals[userId] = { status: 'approved', at: nowISO() };
  r.blockedReviewerIds = (r.blockedReviewerIds || []).filter(id => id !== userId);

  updateReviewState(t);
  renderAll();
}

function approveStaffTest(taskId, userId){
  const t = findTask(taskId); if(!t) return;
  const r = ensureReview(t);
  if(!r.staffTestEnabled) return;

  r.staffApprovedBy[userId] = { at: nowISO() };
  updateReviewState(t);
  renderAll();
}

function setRequiredReviewer(taskId, userId, checked=true){
          const t = findTask(taskId); if(!t) return;
          const r = ensureReview(t);
          if(checked){
            const ids = new Set(r.requiredReviewerIds||[]);
            ids.add(userId);
            r.requiredReviewerIds = Array.from(ids).slice(0, 3);
          } else {
            r.requiredReviewerIds = (r.requiredReviewerIds||[]).filter(id => id !== userId);
            if (r.approvals?.[userId]) delete r.approvals[userId];
            r.blockedReviewerIds = (r.blockedReviewerIds||[]).filter(id => id !== userId);
          }
          t.updated_at = nowISO();
          renderAll();
        }

function removeRequiredReviewer(taskId, userId){
  const t = findTask(taskId); if(!t) return;
  const r = ensureReview(t);
  r.requiredReviewerIds = (r.requiredReviewerIds||[]).filter(id => id !== userId);

  // required から外れたら承認も無効化（仕様）
  if (r.approvals?.[userId]) delete r.approvals[userId];
  r.blockedReviewerIds = (r.blockedReviewerIds||[]).filter(id => id !== userId);

  t.updated_at = nowISO();
  renderAll();
}

function updateReviewState(t){
  if(!requiresReview(t)) return;
  const r = ensureReview(t);

  // 差し戻し中は完了判定しない（再レビュー依頼で requested に戻す）
  if (r.state === 'changes_requested') return;

  const prog = reviewProgress(t);

  if(prog.isApproved){
    r.state = 'approved';
    t.status = 'done';
  } else {
    if (t.status === 'in_review') r.state = 'requested';
    if (r.state === 'approved') r.state = 'requested';
  }

  t.updated_at = nowISO();
}

function hydrateTaskInspector(taskId) {
      const t = state.tasks.find(x => x.id === taskId);
      if (!t) return;

      // Header bits
      document.getElementById('task-code').textContent = `TP-${t.short}`;
      document.getElementById('task-space').textContent = spaces[t.spaceId]?.name || '';

      // Title / desc
      const titleEl = document.getElementById('task-title');
      titleEl.value = t.title;
      titleEl.oninput = () => { t.title = titleEl.value; renderAll(); };

      const descEl = document.getElementById('task-desc');
      descEl.value = t.description || '';
      descEl.oninput = () => { t.description = descEl.value; };

      // Status
      const s = statusMeta[t.status] || statusMeta.todo;
      document.getElementById('task-status-label').textContent = s.label;
      document.getElementById('task-status-dot').className = `w-2 h-2 rounded-full flex-shrink-0 ${s.dot}`;

      // Assignee
      document.getElementById('task-assignee-label').textContent = t.assigneeId ? users[t.assigneeId].name : '未割り当て';

      // Due
      document.getElementById('task-due-label').textContent = t.due ? shortDate(t.due) : '期限なし';
      const dueInput = document.getElementById('due-input');
      dueInput.value = t.due || '';


      // Review
      const reviewBody = document.getElementById('task-review-body');
      const reviewerBox = document.getElementById('reviewer-checkboxes');
      const staffToggle = document.getElementById('staff-approval-toggle');

      // ensure review defaults if needed
      const required = requiresReview(t) ? getRequiredReviewers(t) : (t.review?.requiredReviewerIds || []);
      const prog = requiresReview(t) ? reviewProgress(t) : { approvedCount: 0, total: 0, staffOk: true, isApproved: true };

      const avatar = (pid) => {
        const p = getPerson(pid);
        return `<span class="w-6 h-6 rounded-full bg-gray-100 border border-gray-200 flex items-center justify-center text-2xs font-bold text-gray-700" title="${escapeHtml(p.name)}">${escapeHtml(p.initials || '?')}</span>`;
      };

      reviewBody.innerHTML = `
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-2">
            <div class="flex -space-x-1">${required.map(avatar).join('')}</div>
            <div class="text-xs text-gray-700">${prog.approvedCount}/${prog.total} 承認</div>
            ${t.review?.staffTestEnabled ? `<div class="text-2xs text-gray-500">スタッフ:${prog.staffOk ? 'OK' : '未'}</div>` : ''}
          </div>
          <div class="flex items-center gap-2">
            ${t.status !== 'in_review' ? `<button class="text-xs px-2 py-1 rounded-md border border-gray-200 hover:bg-gray-50" onclick="requestReview('${t.id}')">${(t.review?.state==='changes_requested') ? '再レビュー依頼' : 'レビュー依頼'}</button>` : `<span class="text-2xs text-gray-500">レビュー中</span>`}
          </div>
        </div>
        ${t.review?.lastFeedback ? `<div class="mt-2 text-xs text-red-600">差し戻し: ${escapeHtml(t.review.lastFeedback)}</div>` : ''}
      `;

      // Reviewer checkboxes
      const selected = new Set(required);
      const maxRequired = spaceReviewDefaults[t.spaceId]?.maxRequired || 3;

      const renderCheckboxRow = (pid) => {
        const p = getPerson(pid);
        const checked = selected.has(pid) ? 'checked' : '';
        const disabled = (!selected.has(pid) && selected.size >= maxRequired) ? 'disabled' : '';
        return `
          <label class="flex items-center gap-2 text-xs text-gray-700">
            <input type="checkbox" ${checked} ${disabled} onchange="setRequiredReviewer('${t.id}', '${pid}', this.checked)">
            <span>${escapeHtml(p.name)}</span>
          </label>
        `;
      };

      reviewerBox.innerHTML = `
        <div class="text-2xs font-bold text-gray-400 uppercase mt-1">社内</div>
        ${Object.keys(users).map(renderCheckboxRow).join('')}
        <div class="text-2xs font-bold text-gray-400 uppercase mt-2">クライアント</div>
        ${Object.keys(clientUsers).map(renderCheckboxRow).join('')}
      `;

      // Staff approval toggle (visual sync)
      const knob = staffToggle?.parentElement?.querySelector('div > div');
      const track = staffToggle?.parentElement?.querySelector('div');
      if (staffToggle) {
        staffToggle.checked = !!t.review?.staffTestEnabled;
        if (track && knob) {
          track.classList.toggle('bg-gray-200', !staffToggle.checked);
          track.classList.toggle('bg-green-500', staffToggle.checked);
          knob.classList.toggle('translate-x-0.5', !staffToggle.checked);
          knob.classList.toggle('translate-x-4', staffToggle.checked);
        }
      }


      // Publish toggle (preview barrier)
      document.getElementById('btn-publish').classList.toggle('hidden', !t.isClientVisible);
      document.getElementById('btn-unpublished').classList.toggle('hidden', t.isClientVisible);

      // Missing recovery bar (assignee)
      const slot = document.getElementById('task-alert-slot');
      slot.innerHTML = '';
      if (!t.assigneeId) {
        slot.innerHTML = `
          <div class="bg-red-50 border-b border-red-100 px-5 py-3 flex items-center justify-between missing-alert flex-shrink-0">
            <div class="flex items-center gap-2 text-red-700 text-xs font-bold"><i class="ph-fill ph-warning"></i> 担当者を設定してください</div>
            <button onclick="setAssignee('${me.id}')" class="bg-white border border-red-200 text-red-700 text-xs font-medium px-3 py-1 rounded hover:bg-red-50 shadow-sm">自分を割り当て</button>
          </div>
        `;
      }

      // Audit line
      const audit = document.getElementById('task-audit');
      const created = `作成: ${users[t.createdBy]?.name || '—'} / ${shortDateTime(t.createdAt)}`;
      const assigned = t.assignedAt
        ? `割り当て: ${users[t.assignedBy]?.name || '—'} / ${shortDateTime(t.assignedAt)}`
        : '割り当て: —';
      audit.textContent = `${created}  ・  ${assigned}`;

      // Keep current active for publish confirm
      window.__activeTaskId = taskId;
    }

    function setTaskStatus(arg1, arg2 = null, opts = {}) {
      let t = null;
      let nextStatus = null;

      const statusSet = new Set(['backlog','todo','in_progress','in_review','done']);

      if (arg2 === null && statusSet.has(arg1)) {
        // Called from inspector menu: setTaskStatus('done')
        t = activeTask();
        nextStatus = arg1;
      } else {
        // Called with explicit taskId: setTaskStatus(taskId, 'done')
        t = state.tasks.find(x => x.id === arg1);
        nextStatus = arg2;
      }
      if (!t || !statusSet.has(nextStatus)) return;

      const prevStatus = t.status;
      const prevReview = t.review ? JSON.parse(JSON.stringify(t.review)) : null;

      // Enforce: cannot mark done if review required and not approved
      if (nextStatus === 'done' && requiresReview(t)) {
        const prog = reviewProgress(t);
        if (!prog.isApproved) {
          showToast('完了にできません：必須レビュアーの承認が揃っていません');
          // keep status as-is
          return;
        }
      }

      // If entering review, stamp request time (and ensure defaults)
      if (nextStatus === 'in_review') {
        if (!t.review) t.review = { requiredReviewerIds: [], approvals: {}, staffTestEnabled: false, staffApprovedBy: {}, requestedAt: null, requestedBy: null, lastFeedback: null };
        getRequiredReviewers(t);
        t.review.requestedAt = t.review.requestedAt || nowISO();
        t.review.requestedBy = t.review.requestedBy || 'yuta';
      }

      t.status = nextStatus;
      t.updated_at = nowISO();

      lastAction = { type: 'status', taskId: t.id, prevStatus, prevReview };

      if (!opts.silentToast) showToast('ステータスを更新しました', 'Undo', () => undoLastAction());

      togglePopover('pop-status', false);
      hydrateTaskInspector(t.id);
      renderAll();
    }

    function setAssignee(userId) {
      const t = activeTask();
      if (!t) return;

      const prev = t.assigneeId;
      t.assigneeId = userId;

      // Assignment audit (only when transitioning null -> non-null OR changing assignee)
      if (userId !== prev) {
        t.assignedAt = new Date().toISOString();
        t.assignedBy = me.id;
      }

      // Missing-assignee inbox rule: create notification when assignee is null; clear when set.
      syncMissingAssigneeNotification(t);

      togglePopover('pop-assignee', false);
      hydrateTaskInspector(t.id);
      renderAll();
    }

    function syncMissingAssigneeNotification(task) {
      const id = `missing_${task.id}`;
      const existingIdx = state.inbox.findIndex(n => n.id === id);

      if (!task.assigneeId) {
        if (existingIdx === -1) {
          state.inbox.unshift({
            id,
            type: 'missing_assignee',
            spaceId: task.spaceId,
            taskId: task.id,
            title: `未割り当て: ${task.title}`,
            snippet: 'あなたが作成したタスクに担当者が設定されていません。',
            createdAt: new Date().toISOString(),
            unread: true,
            clientVisible: false
          });
        }
      } else {
        if (existingIdx !== -1) state.inbox.splice(existingIdx, 1);
      }
    }

    function applyDueFromInput() {
      const t = activeTask();
      if (!t) return;
      const val = document.getElementById('due-input').value;
      t.due = val || null;
      togglePopover('pop-due', false);
      hydrateTaskInspector(t.id);
      renderAll();
    }

    function clearDue() {
      const t = activeTask();
      if (!t) return;
      t.due = null;
      document.getElementById('due-input').value = '';
      togglePopover('pop-due', false);
      hydrateTaskInspector(t.id);
      renderAll();
    }

    function activeTask() {
      if (state.inspector.kind !== 'task') return null;
      return state.tasks.find(x => x.id === state.inspector.id) || null;
    }

    // ----------------------------------------------------------------------------------
    // Inbox Inspector (triage) - never edit tasks here
    // ----------------------------------------------------------------------------------

    function hydrateInboxInspector(inboxId) {
      const n = state.inbox.find(x => x.id === inboxId);
      if (!n) return;

      window.__activeInboxId = inboxId;

      const titleEl = document.getElementById('inbox-inspector-title');
      const bodyEl = document.getElementById('inbox-inspector-body');

      if (n.type === 'client_reply') {
        titleEl.innerHTML = `<i class="ph-fill ph-chat-circle-text text-amber-500"></i> クライアントからの返信`;
        bodyEl.innerHTML = `
          <div class="mb-6 p-4 bg-amber-50 border border-amber-200 rounded-lg shadow-sm">
            <div class="flex items-center gap-2 text-amber-800 font-bold text-xs mb-2">
              <i class="ph-fill ph-user"></i> Client User
              <span class="text-amber-600/70 font-normal ml-auto">${escapeHtml(relativeTime(n.createdAt))}</span>
            </div>
            <p class="text-sm text-gray-800 leading-relaxed">${escapeHtml(n.snippet)}</p>
          </div>
          <div class="mb-6">
            <textarea class="w-full border border-gray-300 rounded-lg p-3 text-sm focus:ring-2 focus:ring-indigo-500 outline-none resize-none h-24 mb-2" placeholder="返信を入力..."></textarea>
            <div class="flex justify-end">
              <button onclick="replyAndResolveInbox()" class="bg-indigo-600 hover:bg-indigo-700 text-white text-xs font-bold py-2 px-4 rounded shadow-sm transition-colors">返信して完了</button>
            </div>
          </div>
          <hr class="border-gray-100 mb-6">
          <div class="text-xs font-bold text-gray-400 uppercase mb-2">対象のタスク</div>
          <div class="text-sm font-semibold text-gray-900">${escapeHtml(n.title)}</div>
          <div class="text-xs text-gray-500 mt-1">ここでは編集しない。編集は必ず右ペイン(Task Inspector)で行う。</div>
        `;
      } else if (n.type === 'missing_assignee') {
        titleEl.innerHTML = `<i class="ph-fill ph-warning text-red-600"></i> 未割り当て`;
        bodyEl.innerHTML = `
          <div class="p-4 bg-red-50 border border-red-200 rounded-lg">
            <div class="text-xs font-bold text-red-700 mb-2">担当者が必要</div>
            <div class="text-sm text-gray-800">${escapeHtml(n.title)}</div>
            <div class="text-xs text-gray-600 mt-2">${escapeHtml(n.snippet)}</div>
          </div>
          <div class="mt-4 text-xs text-gray-500">「プロジェクトで開く」から Task Inspector を開いて割り当てしてください。</div>
        `;
      } else {
        titleEl.innerHTML = `<i class="ph-fill ph-bell text-blue-600"></i> 通知`;
        bodyEl.innerHTML = `<div class="text-sm text-gray-700">${escapeHtml(n.title)}</div>`;
      }
    }

    function markInboxRead() {
      const n = state.inbox.find(x => x.id === window.__activeInboxId);
      if (!n) return;
      n.unread = false;
      renderAll();
    }

    function markAllInboxRead() {
      state.inbox.forEach(n => n.unread = false);
      renderAll();
    }

    function replyAndResolveInbox() {
      // Prototype: mark read + keep item but unread false
      markInboxRead();
      closeInspector();
    }

    function transitionToTaskProjectFromInbox() {
      const n = state.inbox.find(x => x.id === window.__activeInboxId);
      if (!n || !n.taskId) return;
      // 1) Switch view to project tasks context
      closeInspector();
      switchView('tasks');
      // 2) Open task inspector
      setTimeout(() => openTaskInspector(n.taskId), 150);
    }

    // ----------------------------------------------------------------------------------
    // Publish safety barrier
    // ----------------------------------------------------------------------------------

    function openPublishConfirm() {
      const t = activeTask();
      if (!t) return;
      document.getElementById('publish-preview').innerHTML = `
        公開対象: <strong>${escapeHtml(spaces[t.spaceId]?.name || '')}</strong><br>
        タスク: <strong>TP-${t.short} ${escapeHtml(t.title)}</strong>
      `;
      const modal = document.getElementById('modal-publish-confirm');
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }

    function closePublishConfirm() {
      const modal = document.getElementById('modal-publish-confirm');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }

    function togglePublishNow() {
      const t = activeTask();
      if (!t) return;
      t.isClientVisible = !t.isClientVisible;
      closePublishConfirm();
      hydrateTaskInspector(t.id);
      renderAll();
    }

    // ----------------------------------------------------------------------------------
    // Popover helpers (Enter/Esc constraints simplified)
    // ----------------------------------------------------------------------------------

    function togglePopover(id, force) {
      const el = document.getElementById(id);
      if (!el) return;
      const show = (typeof force === 'boolean') ? force : el.classList.contains('hidden');
      el.classList.toggle('hidden', !show);
    }

    // ----------------------------------------------------------------------------------
    // Create sheet
    // ----------------------------------------------------------------------------------

    function openCreateSheet(options = {}) {
      // context = current view's space, default to current space (project), personal view uses personal
      const ctx = (state.currentView === 'my') ? spaces.personal : spaces[state.currentSpaceId];
      document.getElementById('create-context').innerHTML = `<i class="ph-fill ${ctx.id==='personal' ? 'ph-target' : 'ph-planet'} text-indigo-500"></i> ${escapeHtml(ctx.name)}`;

      state.create = { category: 'task', assignee: null, due: null, priority: 1, status: (options.status || (state.taskTab === 'backlog' ? 'backlog' : 'todo')) };
      setCreateCategory('task');
      setCreateAssignee(null);
      setCreateDue(null);

      const sheet = document.getElementById('sheet-create');
      sheet.classList.remove('hidden');
      sheet.classList.add('flex');
      document.getElementById('create-title').focus();
    }

    function closeCreateSheet() {
      const sheet = document.getElementById('sheet-create');
      sheet.classList.add('hidden');
      sheet.classList.remove('flex');
      // close any create popovers
      ['menu-cat','create-pop-assignee','create-pop-due'].forEach(id => togglePopover(id, false));
    }

    function setCreateCategory(cat) {
      state.create.category = cat;
      const icon = document.getElementById('icon-cat');
      const label = document.getElementById('label-cat');
      if (cat === 'bug') { icon.className = 'ph-fill ph-bug text-red-600'; label.textContent = 'バグ'; }
      else if (cat === 'client') { icon.className = 'ph-fill ph-chat-circle-text text-amber-500'; label.textContent = 'クライアント要確認'; }
      else { icon.className = 'ph-fill ph-check-circle text-indigo-600'; label.textContent = 'タスク'; }
      togglePopover('menu-cat', false);
    }

    function setCreateAssignee(userId) {
      state.create.assignee = userId;
      togglePopover('create-pop-assignee', false);
    }

    function setCreateDue(dateStr) {
      state.create.due = dateStr;
      const input = document.getElementById('create-due');
      input.value = dateStr || '';
    }

    function applyCreateDue() {
      state.create.due = document.getElementById('create-due').value || null;
      togglePopover('create-pop-due', false);
    }

    function submitCreate() {
      const title = document.getElementById('create-title').value.trim();
      if (!title) {
        document.getElementById('create-title').placeholder = 'タイトルは必須';
        document.getElementById('create-title').focus();
        return;
      }

      const spaceId = (state.currentView === 'my') ? 'personal' : state.currentSpaceId;

      const nextShort = Math.max(...state.tasks.map(t => t.short)) + 1;
      const nowIso = new Date().toISOString();

      const t = {
        id: `t${nextShort}`,
        short: nextShort,
        spaceId,
        title,
        description: '',
        status: (state.create.status || 'todo'),
        category: state.create.category,
        priority: 1,
        assigneeId: state.create.assignee,
        due: state.create.due,
        createdAt: nowIso,
        createdBy: me.id,
        assignedAt: state.create.assignee ? nowIso : null,
        assignedBy: state.create.assignee ? me.id : null,
        isClientVisible: (state.create.category === 'client') // demo: client-check tends to be visible
      };

      state.tasks.unshift(t);
      // missing assignee → inbox notification
      syncMissingAssigneeNotification(t);

      closeCreateSheet();

      // Auto open Inspector after create
      if (spaceId === 'personal') {
        switchView('my');
      } else {
        // choose view based on category
        if (t.category === 'client') {
            switchView('client_wait');
          } else {
            // Bugs are just a filter inside Tasks
            state.taskCategoryFilter = (t.category === 'bug') ? 'bug' : 'all';
            switchView('tasks');
          }
      }

      openTaskInspector(t.id);

      // Keep creating toggle (prototype only)
      const keep = document.getElementById('create-keep').checked;
      if (keep) {
        setTimeout(() => openCreateSheet(), 200);
      }
    }

    // Toggle pill UI
    document.getElementById('create-keep').addEventListener('change', (e) => {
      const on = e.target.checked;
      const pill = document.getElementById('keep-pill');
      const dot = document.getElementById('keep-dot');
      pill.className = `relative inline-flex items-center h-4 rounded-full w-8 transition-colors ${on ? 'bg-indigo-600' : 'bg-gray-200'}`;
      dot.className = `w-3 h-3 bg-white rounded-full shadow transform transition-transform ${on ? 'translate-x-4' : 'translate-x-0.5'}`;
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      const tag = document.activeElement.tagName;
      const typing = tag === 'INPUT' || tag === 'TEXTAREA';


      // Ctrl/Cmd+Z: undo last action (non-typing only)
      if ((e.ctrlKey || e.metaKey) && (e.key === 'z' || e.key === 'Z') && !typing) {
        e.preventDefault();
        undoLastAction();
        return;
      }

      // C: create
      if ((e.key === 'c' || e.key === 'C') && !typing) {
        e.preventDefault();
        openCreateSheet();
      }

      // Enter: create when create sheet open & focus is title
      const sheet = document.getElementById('sheet-create');
      const sheetOpen = !sheet.classList.contains('hidden');
      if (sheetOpen && e.key === 'Enter' && document.activeElement.id === 'create-title') {
        e.preventDefault();
        submitCreate();
      }

      // Esc: close inspector or sheet (priority: popovers -> sheet -> inspector)
      if (e.key === 'Escape') {
        const anyPopover = ['menu-cat','create-pop-assignee','create-pop-due','pop-status','pop-assignee','pop-due']
          .some(id => {
            const el = document.getElementById(id);
            return el && !el.classList.contains('hidden');
          });
        if (anyPopover) {
          ['menu-cat','create-pop-assignee','create-pop-due','pop-status','pop-assignee','pop-due'].forEach(id => togglePopover(id, false));
          return;
        }
        if (sheetOpen) { closeCreateSheet(); return; }
        closeInspector();
      }
    });

    // ----------------------------------------------------------------------------------
    // Placeholder inspector for meetings/wiki/views (they still open right inspector; same rule)
    // ----------------------------------------------------------------------------------

    function openMeetingInspector(meetingId) {
      // For now: treat as inbox inspector style to avoid creating a new edit pattern.
      const fakeInboxId = `meeting_${meetingId}`;
      const m = state.meetings.find(x => x.id === meetingId);
      if (!m) return;
      // create temp notification object
      const tmp = {
        id: fakeInboxId, type: 'info', spaceId: state.currentSpaceId, taskId: null,
        title: m.title, snippet: 'Meetings Inspectorは別実装(Transcript|Extract|Apply)。このプロトタイプでは省略。', createdAt: m.heldAt, unread: false, clientVisible: false
      };
      state.inbox = state.inbox.filter(x => !x.id.startsWith('meeting_'));
      state.inbox.unshift(tmp);
      openInboxInspector(fakeInboxId);
    }

    function openWikiInspector(pageId) {
      const w = state.wiki.find(x => x.id === pageId);
      if (!w) return;
      const fakeInboxId = `wiki_${pageId}`;
      const tmp = {
        id: fakeInboxId, type: 'info', spaceId: state.currentSpaceId, taskId: null,
        title: w.title, snippet: 'Wiki Inspectorは別実装。公開時はマイルストーン公開に従属。', createdAt: w.updated_at, unread: false, clientVisible: false
      };
      state.inbox = state.inbox.filter(x => !x.id.startsWith('wiki_'));
      state.inbox.unshift(tmp);
      openInboxInspector(fakeInboxId);
    }

    function applyView(viewId) {
      // Prototype: just switch to tasks and highlight conceptually
      switchView('tasks');
    }

    // ----------------------------------------------------------------------------------
    // Utilities
    // ----------------------------------------------------------------------------------

    function isoNowMinus(seconds) {
      return new Date(Date.now() - seconds * 1000).toISOString();
    }

    function shortDate(dateStr) {
      const d = new Date(dateStr);
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      return `${m}/${day}`;
    }

    function shortDateTime(iso) {
      const d = new Date(iso);
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      const hh = String(d.getHours()).padStart(2,'0');
      const mm = String(d.getMinutes()).padStart(2,'0');
      return `${m}/${day} ${hh}:${mm}`;
    }

    function relativeTime(iso) {
      const diff = Math.max(0, Date.now() - new Date(iso).getTime());
      const mins = Math.floor(diff / 60000);
      if (mins < 1) return 'たった今';
      if (mins < 60) return `${mins}分前`;
      const hours = Math.floor(mins / 60);
      if (hours < 24) return `${hours}時間前`;
      const days = Math.floor(hours / 24);
      return `${days}日前`;
    }

    function escapeHtml(str) {
      return String(str)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }

    // ----------------------------------------------------------------------------------
    // Init
    // ----------------------------------------------------------------------------------

    function initFromUrl() {
      const url = new URL(window.location.href);
      const taskId = url.searchParams.get('task');
      const inboxId = url.searchParams.get('inbox');
      if (taskId) {
        switchView('tasks');
        openTaskInspector(taskId);
        return;
      }
      if (inboxId) {
        

        // App Mode Switch (internal <-> client portal)
        function switchAppMode(mode) {
            const internal = document.getElementById('app-internal');
            const client = document.getElementById('app-client');
            if (!internal || !client) return;

            if (mode === 'client') {
                internal.classList.add('hidden');
                client.classList.remove('hidden');
                // default: review queue
                if (typeof setClientMode === 'function') setClientMode('review');
            } else {
                client.classList.add('hidden');
                internal.classList.remove('hidden');
                // restore a sensible view
                if (typeof switchView === 'function') switchView('inbox');
            }
        }
switchView('inbox');
        openInboxInspector(inboxId);
        return;
      }
      switchView('inbox');
    }

    initFromUrl();
    renderAll();
  </script>


    <!-- ==================================================================================== -->
    <!-- CLIENT REVIEW PORTAL (Read-only + Comments) -->
    <!-- ==================================================================================== -->
    <div id="app-client" class="hidden w-full h-full">
        <div class="flex w-full h-full">
            <!-- LEFT NAV (Client) -->
            <aside class="w-[240px] bg-[#F7F8F9] border-r border-gray-200 flex flex-col flex-shrink-0 select-none">
                <div class="h-12 flex items-center px-3 gap-2 mt-1">
                    <div class="flex items-center gap-2 px-2 py-1 rounded hover:bg-gray-200/60 cursor-pointer flex-1 transition-colors">
                        <div class="w-4 h-4 bg-amber-500 rounded flex items-center justify-center text-white text-2xs font-bold shadow-sm">C</div>
                        <span class="font-medium text-gray-900 truncate">クライアントポータル</span>
                    </div>
                </div>

                <div class="flex-1 overflow-y-auto px-2 pt-2 space-y-6">
                    <div class="space-y-0.5">
                        <div id="cnav-review" onclick="switchClientView('review')" class="px-2 py-1.5 text-gray-900 bg-gray-200/60 rounded cursor-pointer flex items-center gap-2 font-medium group transition-colors">
                            <i class="ph ph-check-square-offset text-lg text-gray-500 group-hover:text-gray-900"></i> 今日チェック
                            <span class="ml-auto text-2xs bg-amber-100 text-amber-800 px-1.5 py-0.5 rounded">3</span>
                        </div>
                        <div id="cnav-milestones" onclick="switchClientView('milestones')" class="px-2 py-1.5 text-gray-600 hover:bg-gray-200/50 rounded cursor-pointer flex items-center gap-2 group transition-colors">
                            <i class="ph ph-flag text-lg text-gray-500 group-hover:text-gray-900"></i> マイルストーン
                        </div>
                        <div id="cnav-wiki" onclick="switchClientView('wiki')" class="px-2 py-1.5 text-gray-600 hover:bg-gray-200/50 rounded cursor-pointer flex items-center gap-2 group transition-colors">
                            <i class="ph ph-book-open-text text-lg text-gray-500 group-hover:text-gray-900"></i> Wiki
                        </div>
                    </div>

                    <div class="px-2 text-2xs text-gray-500 leading-relaxed">
                        <div class="font-medium text-gray-600 mb-1">ルール</div>
                        <ul class="list-disc pl-4 space-y-1">
                            <li>閲覧とコメントのみ（編集不可）</li>
                            <li>あなたの「確認」は履歴に残ります</li>
                        </ul>
                    </div>
                </div>
            </aside>

            <!-- MAIN (Client) -->
            <main class="flex-1 flex flex-col bg-white min-w-0">
                <header class="h-12 border-b border-gray-100 flex items-center justify-between px-5 flex-shrink-0 bg-white">
                    <div class="flex items-center gap-2 text-sm">
                        <span class="font-medium text-gray-900">今日チェック</span>
                        <span class="text-gray-400">/</span>
                        <span class="text-xs text-gray-500">Webリニューアル</span>
                        <span class="inline-flex items-center gap-1 px-1.5 py-0.5 rounded text-2xs font-medium bg-amber-50 text-amber-700 border border-amber-200 ml-2">
                            <i class="ph-fill ph-eye"></i> クライアント表示
                        </span>
                    </div>
                    <div class="flex items-center gap-3">
                    <button onclick="switchAppMode('internal')" class="text-xs text-gray-600 flex items-center gap-1 px-2 py-1 rounded hover:bg-gray-100"><i class="ph ph-arrow-left"></i> 社内画面へ</button>
                        <div class="flex gap-1">
                            <button class="px-3 py-1.5 text-xs font-medium text-gray-900 bg-gray-100 rounded-md" onclick="setClientFilter('pending')">未確認</button>
                            <button class="px-3 py-1.5 text-xs font-medium text-gray-500 hover:text-gray-900" onclick="setClientFilter('done')">確認済み</button>
                            <button class="px-3 py-1.5 text-xs font-medium text-gray-500 hover:text-gray-900" onclick="setClientFilter('all')">すべて</button>
                        </div>
                    </div>
                </header>

                <!-- VIEW: REVIEW QUEUE -->
                <div id="cview-review" class="flex-1 overflow-y-auto">
                    <div class="px-5 py-2 text-xs font-medium text-gray-500">今日</div>

                    <!-- Item: Task review -->
                    <div class="flex items-center gap-3 px-5 py-2 border-b border-gray-50 hover:bg-gray-50 cursor-pointer h-10" onclick="openClientInspector('ctask1')">
                        <div class="w-5 h-5 rounded bg-indigo-100 text-indigo-600 flex items-center justify-center text-[10px] flex-shrink-0"><i class="ph-fill ph-check-circle"></i></div>
                        <div class="flex-1 min-w-0 flex items-center gap-2">
                            <span class="text-sm text-gray-900 font-medium truncate">ログイン画面の文言調整</span>
                            <span class="text-2xs text-gray-400">(タスク)</span>
                        </div>
                        <div class="text-xs text-gray-500 flex items-center gap-3 flex-shrink-0">
                            <span class="px-1.5 py-0.5 rounded text-2xs bg-amber-50 text-amber-700 border border-amber-200">未確認</span>
                            <span class="w-16 truncate">M1</span>
                            <span class="w-16 truncate">2/3</span>
                        </div>
                    </div>

                    <!-- Item: Discussion waiting client -->
                    <div class="flex items-center gap-3 px-5 py-2 border-b border-gray-50 hover:bg-gray-50 cursor-pointer h-10" onclick="openClientInspector('cdisc1')">
                        <div class="w-5 h-5 rounded bg-amber-100 text-amber-600 flex items-center justify-center text-[10px] flex-shrink-0"><i class="ph-fill ph-chat-circle-text"></i></div>
                        <div class="flex-1 min-w-0 flex items-center gap-2">
                            <span class="text-sm text-gray-900 font-medium truncate">ヒーロー画像は写真？イラスト？</span>
                            <span class="text-2xs text-gray-400">(要確認)</span>
                        </div>
                        <div class="text-xs text-gray-500 flex items-center gap-3 flex-shrink-0">
                            <span class="px-1.5 py-0.5 rounded text-2xs bg-amber-50 text-amber-700 border border-amber-200">未確認</span>
                            <span class="w-16 truncate">M1</span>
                            <span class="w-16 truncate">2/4</span>
                        </div>
                    </div>

                    <!-- Item: Milestone approval -->
                    <div class="flex items-center gap-3 px-5 py-2 border-b border-gray-50 hover:bg-gray-50 cursor-pointer h-10" onclick="openClientInspector('cms1')">
                        <div class="w-5 h-5 rounded bg-gray-100 text-gray-600 flex items-center justify-center text-[10px] flex-shrink-0"><i class="ph-fill ph-flag"></i></div>
                        <div class="flex-1 min-w-0 flex items-center gap-2">
                            <span class="text-sm text-gray-900 font-medium truncate">M1: 基盤構築（まとめて承認）</span>
                            <span class="text-2xs text-gray-400">(マイルストーン)</span>
                        </div>
                        <div class="text-xs text-gray-500 flex items-center gap-3 flex-shrink-0">
                            <span class="px-1.5 py-0.5 rounded text-2xs bg-amber-50 text-amber-700 border border-amber-200">未確認</span>
                            <span class="w-16 truncate">—</span>
                            <span class="w-16 truncate">2/5</span>
                        </div>
                    </div>
                </div>

                <!-- VIEW: MILESTONES -->
                <div id="cview-milestones" class="flex-1 overflow-y-auto hidden">
                    <div class="px-5 py-3 border-b border-gray-50">
                        <div class="text-sm font-medium text-gray-900">公開中のマイルストーン</div>
                        <div class="text-xs text-gray-500 mt-1">詳細は右のパネルで確認できます。</div>
                    </div>
                    <div class="flex items-center gap-3 px-5 py-2 border-b border-gray-50 hover:bg-gray-50 cursor-pointer h-10" onclick="openClientInspector('cms1')">
                        <div class="w-5 h-5 rounded bg-gray-100 text-gray-600 flex items-center justify-center text-[10px] flex-shrink-0"><i class="ph-fill ph-flag"></i></div>
                        <div class="flex-1 min-w-0 flex items-center gap-2">
                            <span class="text-sm text-gray-900 font-medium truncate">M1: 基盤構築</span>
                        </div>
                        <div class="text-xs text-gray-500 flex items-center gap-3 flex-shrink-0">
                            <span class="w-16 truncate">2/5</span>
                            <span class="px-1.5 py-0.5 rounded text-2xs bg-amber-50 text-amber-700 border border-amber-200">公開中</span>
                        </div>
                    </div>
                </div>

                <!-- VIEW: WIKI -->
                <div id="cview-wiki" class="flex-1 overflow-y-auto hidden">
                    <div class="px-5 py-3 border-b border-gray-50">
                        <div class="text-sm font-medium text-gray-900">Wiki</div>
                        <div class="text-xs text-gray-500 mt-1">公開された情報だけが表示されます。</div>
                    </div>
                    <div class="flex items-center gap-3 px-5 py-2 border-b border-gray-50 hover:bg-gray-50 cursor-pointer h-10" onclick="openClientInspector('cwiki1')">
                        <div class="w-5 h-5 rounded bg-gray-100 text-gray-600 flex items-center justify-center text-[10px] flex-shrink-0"><i class="ph-fill ph-book"></i></div>
                        <div class="flex-1 min-w-0 flex items-center gap-2">
                            <span class="text-sm text-gray-900 font-medium truncate">仕様: ログインフロー</span>
                        </div>
                        <div class="text-xs text-gray-500 flex-shrink-0">2/2 更新</div>
                    </div>
                </div>
            </main>

            <!-- RIGHT INSPECTOR (Client) -->
            <aside id="cinspector" class="bg-white flex flex-col flex-shrink-0 h-full z-10 shadow-pane border-l border-gray-200 relative" style="width:0;overflow:hidden;transition:width 150ms ease-out;">
                <div id="cinspector-inner" class="h-full flex flex-col w-[400px]">
                    <!-- Header -->
                    <div class="h-12 border-b border-gray-100 flex items-center justify-between px-5 flex-shrink-0 bg-gray-50/50">
                        <div id="cinspector-title" class="text-xs font-semibold text-gray-700">詳細</div>
                        <button onclick="closeClientInspector()" class="p-1.5 rounded hover:bg-gray-200 text-gray-400"><i class="ph ph-x"></i></button>
                    </div>

                    <!-- Body -->
                    <div class="flex-1 overflow-y-auto p-6">
                        <div id="cinspector-body">
                            <div class="text-xs text-gray-500">左のリストから選んでください。</div>
                        </div>
                    </div>
                </div>
            </aside>
        </div>
    </div>



<script>
// CLIENT PORTAL JS
(function () {
  let cMode = 'review';     // review | milestone | discussion
  let cFilter = 'pending';  // pending | done | all
  let selectedClientTaskId = null;

  const $ = (id) => document.getElementById(id);

  function clientVisibleTasks() {
    return state.tasks.filter(t => t.isClientVisible);
  }

  function clientQueue() {
    const tasks = clientVisibleTasks();
    if (cFilter === 'pending') return tasks.filter(t => t.status === 'in_review');
    if (cFilter === 'done') return tasks.filter(t => t.status === 'done');
    return tasks;
  }

  function setClientMode(mode) {
    cMode = mode;
    $('client-view-review')?.classList.toggle('hidden', mode !== 'review');
    $('client-view-milestone')?.classList.toggle('hidden', mode !== 'milestone');
    $('client-view-discussion')?.classList.toggle('hidden', mode !== 'discussion');

    $('client-mode-review')?.classList.toggle('text-gray-900', mode === 'review');
    $('client-mode-milestone')?.classList.toggle('text-gray-900', mode === 'milestone');
    $('client-mode-discussion')?.classList.toggle('text-gray-900', mode === 'discussion');

    renderClient();
  }

  function setClientFilter(filter) {
    cFilter = filter;
    $('client-filter-pending')?.classList.toggle('bg-gray-900', filter === 'pending');
    $('client-filter-pending')?.classList.toggle('text-white', filter === 'pending');
    $('client-filter-done')?.classList.toggle('bg-gray-900', filter === 'done');
    $('client-filter-done')?.classList.toggle('text-white', filter === 'done');
    $('client-filter-all')?.classList.toggle('bg-gray-900', filter === 'all');
    $('client-filter-all')?.classList.toggle('text-white', filter === 'all');

    $('client-filter-pending')?.classList.toggle('bg-white', filter !== 'pending');
    $('client-filter-pending')?.classList.toggle('text-gray-700', filter !== 'pending');
    $('client-filter-done')?.classList.toggle('bg-white', filter !== 'done');
    $('client-filter-done')?.classList.toggle('text-gray-700', filter !== 'done');
    $('client-filter-all')?.classList.toggle('bg-white', filter !== 'all');
    $('client-filter-all')?.classList.toggle('text-gray-700', filter !== 'all');

    renderClientReviewList();
  }

  function renderClientBadges() {
    const all = clientVisibleTasks();
    const pending = all.filter(t => t.status === 'in_review').length;
    const done = all.filter(t => t.status === 'done').length;

    const b1 = $('client-badge-review');
    const b2 = $('client-badge-done');
    if (b1) b1.textContent = String(pending);
    if (b2) b2.textContent = String(done);
  }

  function renderClientReviewList() {
    const list = $('cview-review-list');
    if (!list) return;

    const items = clientQueue();

    if (items.length === 0) {
      list.innerHTML = `<div class="p-4 text-xs text-gray-500">レビュー待ちはありません。</div>`;
      return;
    }

    list.innerHTML = items.map(t => {
      const prog = requiresReview(t) ? reviewProgress(t) : { approvedCount: 0, total: 0, staffOk: true, isApproved: true };
      const title = escapeHtml(t.title);
      const statusLabel = escapeHtml(statusMeta[t.status]?.label || t.status);
      const meta = (t.status === 'in_review')
        ? `${prog.approvedCount}/${prog.total} 承認`
        : (t.status === 'done' ? '完了' : statusLabel);

      return `
        <div class="p-4 hover:bg-gray-50 cursor-pointer" onclick="openClientInspector('${t.id}')">
          <div class="flex items-start justify-between">
            <div class="min-w-0">
              <div class="text-sm font-semibold text-gray-900 truncate">${title}</div>
              <div class="mt-1 text-xs text-gray-500">${meta}</div>
            </div>
            <div class="text-xs px-2 py-1 rounded-full border border-gray-200 text-gray-700">${statusLabel}</div>
          </div>
        </div>
      `;
    }).join('');
  }

  function showClientInspector() {
    $('client-inspector-review-task')?.classList.remove('hidden');
    $('client-inspector-review-list')?.classList.add('hidden');
  }
  function showClientList() {
    $('client-inspector-review-task')?.classList.add('hidden');
    $('client-inspector-review-list')?.classList.remove('hidden');
  }

  window.openClientInspector = function (taskId) {
    selectedClientTaskId = taskId;
    const t = state.tasks.find(x => x.id === taskId);
    if (!t) return;

    const titleEl = $('client-task-title');
    const statusEl = $('client-task-status');
    const bodyEl = $('client-task-body');
    if (titleEl) titleEl.textContent = t.title;
    if (statusEl) statusEl.textContent = statusMeta[t.status]?.label || t.status;

    const required = requiresReview(t) ? getRequiredReviewers(t) : [];
    const prog = requiresReview(t) ? reviewProgress(t) : { approvedCount: 0, total: 0, staffOk: true, isApproved: true };
    const me = clientSession.userId;
    const isMeBlocked = (t.review?.blockedReviewerIds || []).includes(me);
    const myState = isMeBlocked ? 'reapprove' : (t.review?.approvals?.[me]?.status || 'pending');

    const line = (rid) => {
      const p = getPerson(rid);
      const isBlocked = (t.review?.blockedReviewerIds || []).includes(rid);
      const st = isBlocked ? 'reapprove' : (t.review?.approvals?.[rid]?.status || 'pending');
      const stLabel = (st === 'reapprove') ? '要再承認' : (st === 'approved') ? '承認済み' : '未';
      return `<div class="flex items-center justify-between py-2 border-b border-gray-100">
        <div class="text-xs text-gray-700">${escapeHtml(p.name)}</div>
        <div class="text-2xs px-2 py-1 rounded-full border border-gray-200 text-gray-600">${stLabel}</div>
      </div>`;
    };

    bodyEl.innerHTML = `
      <div class="mb-4">
        <div class="text-xs font-bold text-gray-400 uppercase">あなたが今日チェックすべきこと</div>
        <div class="mt-2 text-sm text-gray-900">${escapeHtml(t.title)}</div>
        <div class="mt-1 text-xs text-gray-500">完了条件：必須レビュアー ${prog.total}人の承認（${prog.approvedCount}/${prog.total}）${t.review?.staffTestEnabled ? ' ＋ 本番スタッフ承認' : ''}</div>
        ${t.review?.lastFeedback ? (() => { const by = t.review?.lastFeedbackBy ? getPerson(t.review.lastFeedbackBy).name : '不明'; const at = t.review?.lastFeedbackAt ? new Date(t.review.lastFeedbackAt).toLocaleString() : ''; return `<div class="mt-2 text-xs text-red-600">前回差し戻し（${escapeHtml(by)} ${escapeHtml(at)}）: ${escapeHtml(t.review.lastFeedback)}</div>`; })() : ''}
      </div>

      <div class="mb-4">
        <div class="text-xs font-bold text-gray-400 uppercase">必須レビュアー</div>
        <div class="mt-2 rounded-lg border border-gray-200">
          ${required.map(line).join('')}
        </div>
        <div class="mt-2 text-2xs text-gray-500">あなたは「指名されている」ので、あなたの承認が揃わない限り完了になりません。</div>
      </div>

      <div class="mb-4">
        <div class="text-xs font-bold text-gray-400 uppercase">あなたの判定</div>
        <div class="mt-2 text-xs text-gray-700">現在: <span class="font-bold">${myState === 'approved' ? '承認済み' : myState === 'reapprove' ? '要再承認' : '未'}</span></div>
        <div class="mt-3 flex items-center gap-2">
          <button class="text-xs px-3 py-2 rounded-md bg-gray-900 text-white hover:bg-black" onclick="clientApprove()">承認</button>
          <button class="text-xs px-3 py-2 rounded-md border border-gray-200 hover:bg-gray-50" onclick="clientRequestFix()">修正が必要</button>
        </div>
        <textarea id="client-feedback" class="mt-3 w-full rounded-lg border border-gray-200 p-3 text-sm" rows="3" placeholder="（任意）コメント。修正が必要の場合は理由を必ず書いてください。"></textarea>
        <div class="mt-1 text-2xs text-gray-500">承認/差し戻しは「誰が・いつ・何を言ったか」が残ります（証拠）。</div>
      </div>
    `;

    showClientInspector();
  };

  
window.clientApprove = function () {
  if (!selectedClientTaskId) return;
  const t = state.tasks.find(x => x.id === selectedClientTaskId);
  if (!t) return;

  const r = ensureReview(t);
  const me = clientSession.userId;
  const comment = ($('client-feedback')?.value || '').trim();

  // 承認
  r.approvals[me] = { status: 'approved', at: nowISO(), comment };
  r.blockedReviewerIds = (r.blockedReviewerIds || []).filter(id => id !== me);
  if (r.state === 'idle') r.state = 'requested';

  updateReviewState(t);

  renderClientBadges();
  renderClientReviewList();
  openClientInspector(selectedClientTaskId);
};

window.clientRequestFix = function () {
  if (!selectedClientTaskId) return;
  const t = state.tasks.find(x => x.id === selectedClientTaskId);
  if (!t) return;

  const r = ensureReview(t);
  const me = clientSession.userId;
  const comment = ($('client-feedback')?.value || '').trim();
  if (!comment) { alert('差し戻し理由を入力してください'); return; }

  // 証拠（いつ・誰が・何を）
  r.lastFeedback = comment;
  r.lastFeedbackBy = me;
  r.lastFeedbackAt = nowISO();
  r.state = 'changes_requested';

  // ✅ 0からやり直しはさせない：他の承認・社内テストは保持
  // ただし、差し戻しを出した本人だけは再承認必須にする
  if (r.approvals?.[me]) delete r.approvals[me];
  const set = new Set(r.blockedReviewerIds || []);
  set.add(me);
  r.blockedReviewerIds = Array.from(set);

  t.status = 'in_progress';
  t.updated_at = nowISO();

  // 通知（社内側の Inbox に出す想定）
  state.inbox.unshift({
    id: uid(),
    type: 'review_requested_changes',
    title: t.title,
    project: state.spaces[t.spaceId]?.name || 'Project',
    org: state.orgName,
    created_at: nowISO(),
    meta: { taskId: t.id }
  });

  renderAll();
  renderClientBadges();
  renderClientReviewList();
  openClientInspector(selectedClientTaskId);
};

  // wiring
  $('client-mode-review')?.addEventListener('click', () => setClientMode('review'));
  $('client-mode-milestone')?.addEventListener('click', () => setClientMode('milestone'));
  $('client-mode-discussion')?.addEventListener('click', () => setClientMode('discussion'));

  $('client-filter-pending')?.addEventListener('click', () => setClientFilter('pending'));
  $('client-filter-done')?.addEventListener('click', () => setClientFilter('done'));
  $('client-filter-all')?.addEventListener('click', () => setClientFilter('all'));

  $('client-inspector-review-close')?.addEventListener('click', () => showClientList());

  function renderClient() {
    renderClientBadges();
    if (cMode === 'review') renderClientReviewList();
  }

  // initial render (client app is hidden by default, but safe)
  renderClient();
})();
</script>


    <!-- Toast -->
    <div id="toast" class="fixed bottom-4 left-1/2 -translate-x-1/2 z-[60] hidden">
      <div class="bg-gray-900 text-white text-xs px-4 py-2 rounded-lg shadow-popover flex items-center gap-3">
        <span id="toast-msg" class="whitespace-nowrap"></span>
        <button id="toast-action" class="text-xs font-bold underline underline-offset-2 hidden">Undo</button>
      </div>
    </div>

</body>
</html>
