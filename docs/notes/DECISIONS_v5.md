# DECISIONS v5（最新意思決定ログ）

> v4 からの継続 + 認証・招待・課金の意思決定を追加

---

## 認証（2025-02-02 決定）

### 認証方式
- **Supabase Auth**（メール/パスワード）を使用。
- OAuth（Google, GitHub）は **将来対応**（MVP外）。

### 新規登録
- **招待なしの新規登録を許可**する。
- 新規登録時は組織を新規作成し、**Freeプランで開始**。
- 登録者は自動的に組織の `owner` となる。

### ルート設計
- 内部メンバー用: `/:orgId/project/:spaceId`
- クライアント用: `/portal`（認証後）
- 招待ランディング:
  - 内部メンバー: `/invite/:token`
  - クライアント: `/portal/:token`
- **分離フロー採用**（統一ではなく）：セマンティクスの明確化、将来の拡張性を優先。

---

## 招待（2025-02-02 決定）

### 招待権限
- `org.owner` と `space.admin` のみ招待を作成可能。
- その他のロールは招待作成不可。

### 招待フロー
- 招待メールには **組織名・スペース名を含める**。
- 招待の有効期限は **30日間**。
- 再招待時、古いトークンは自動無効化しない（シンプルに運用）。

### 招待受諾
- 新規ユーザー: パスワード設定 → 登録 → メンバーシップ作成
- 既存ユーザー: ログイン済みなら即座にメンバーシップ作成、未ログインならログイン促進

---

## 課金（2025-02-02 決定）

### 決済プロバイダ
- **Stripe** を使用。

### プラン構成
| プラン | プロジェクト | 内部メンバー | クライアント | ストレージ |
|--------|-------------|-------------|-------------|-----------|
| Free | 5 | 5 | 5 | 100MB |
| Pro | 20 | 20 | 20 | 5GB |
| Enterprise | 無制限 | 無制限 | 無制限 | 無制限 |

### 課金単位
- **組織（org）単位**で課金。
- ユーザー単位やスペース単位の課金は行わない。

### MVP実装
- Freeプランのみ実装（Stripe連携なし）。
- Pro/Enterprise + Stripe連携は後フェーズ。

### 制限の適用
- 招待作成時に制限チェック。
- プロジェクト作成時に制限チェック。
- 制限超過時はアップグレード案内を表示。

---

## ダッシュボード/ビュー（v4継続）
- 社内用ダッシュボードとクライアント用ダッシュボードは **用途とデザインを分離**する。
- クライアント側は「何を確認すべきか」を中心に、期限が近い順で強調表示する。

## レビュー（v4継続）
- デフォルト運用は **指名なし（1人承認でOK）**。
- 差し戻し後は、既に通ったチェック項目は維持し、影響範囲のみ再承認。

## 検討中（Considering）（v4継続）
- 検討中は `status=considering` として管理し、通常タスクとは別ビューで扱う。
- ボール（次に動く主体）を導入：`ball=client`（ご確認待ち） / `ball=internal`（当社対応中）。
- `ball=client` に切り替える瞬間に **clientOwnerIds（クライアント担当）1名以上必須**。
- 連続作成時は直前の clientOwnerIds を **自動引き継ぎ**。

## 会議（議事録）（v4継続）
- 会議は **ミーティングごとに作成**し一覧で履歴管理する（プロジェクト固定1つではない）。
- 会議の未決事項は **自動抽出**：
  - `status=considering AND ball=client`
  - レビュー未完了（未承認/再承認待ち）
  - 仮決定（確認相手が選べず確定できなかったもの）
- 会議開始前は「決定/承認」操作を封じる（誤操作防止）。

## 代理入力（会議外確定）（v4継続）
- 会議外（チャット/メール/電話）で確定した内容は、当社が代行でタスクへ反映してOK。
- ただし「クライアント確定として登録」する場合は **確認した相手（必須）＋根拠（必須）＋決定内容（必須）**。
- ログは「入力者（actor）」と「意思（onBehalfOf）」を分離して残す。

## 通知（メール＋アプリ内）（v4継続）
- 会議終了で議事録通知を自動送信。
- 同一会議の二重送信を防ぐため、冪等キー（meetingId+endedAt）で制御する。

## 仕様の正本（v4継続）
- 仕様の正本は **spec/配下のmd**。
- Wikiは索引（リンク集・ショートカット）用途のみ。
- 仕様タスク（type=spec）は `specPath`（/spec/*.md#anchor）と `decisionState`（considering/decided/implemented）を持つ。

## 受け入れ基準（v4継続 + 拡張）
- 受け入れテストは AT-001〜AT-012（REVIEW_SPEC.md）+ AT-AUTH/INVITE/BILLING（AUTH_INVITE_BILLING_SPEC.md）を完了条件とする。

---

---

## MCP連携（2025-02-03 決定 / 一部ペンディング）

### 実装済み
- **横断アクセス認可システム**
  - APIキーに `scope` (space/org/user) を追加
  - `allowed_space_ids` で複数プロジェクトへのアクセス制御
  - `allowed_actions` (read/write/delete/bulk) で操作制限
  - defense-in-depth: API層 + RPC層 + RLS
- **破壊的操作の保護**
  - dry_run/confirm パターン（30秒有効の確認トークン）
- **監査ログ**
  - `api_key_usage` テーブルで操作履歴を記録
- **アカウント設定でのAPIキー管理UI**
  - `/settings/api-keys` でユーザーがAPIキーを発行
  - プロジェクトをチェックボックスで選択
  - 許可する操作を選択

### ペンディング: APIキーのみでの接続

**現状のアーキテクチャ**
```
MCP Server → Supabase（直接接続）
             ↑
         SERVICE_KEY が必要
```

**目標のアーキテクチャ**
```
MCP Server → TaskApp API → Supabase
             ↑
         APIキーのみで認証
```

**実現条件**
- 本番ドメインの確定
- MCPサーバーをHTTP API経由に変更

**期待される設定（将来）**
```json
{
  "mcpServers": {
    "taskapp": {
      "env": {
        "TASKAPP_API_KEY": "tsk_xxxxx",
        "TASKAPP_API_URL": "https://taskapp.example.com/api"
      }
    }
  }
}
```

**優先度**: 本番デプロイ後

---

## プロジェクトプリセット（2026-02-14 決定）

### 概要
Asana/Mondayのようにジャンル別プリセットを用意し、プロジェクト作成時にWiki+マイルストーン+設定を一括セットアップ。

### プリセット管理方式
- **コードベース管理**（TypeScript）。DBにプリセット定義は持たない。
- 理由: 既存の`defaultTemplate.ts`パターンを踏襲。BlockNote JSONの生成関数が必要なためコードが自然。
- ファイル構成: `src/lib/presets/index.ts` + `src/lib/presets/genres/*.ts`

### ジャンル構成（7種）
- `web_development` — Web/アプリ開発（既存spec templateベース）
- `system_development` — 業務システム開発
- `design` — デザイン制作
- `consulting` — コンサルティング
- `marketing` — マーケティング
- `event` — イベント企画
- `blank` — 白紙（テンプレートなし）

### 原子的作成
- **RPC関数 `rpc_create_space_with_preset`** で単一トランザクション内にspace + membership + milestones + wiki pagesを一括作成。
- SECURITY DEFINER + `auth.uid()` で認証。`org_memberships` でメンバーシップ確認。
- 既存パターン（`rpc_confirm_proposal_slot`等）に倣う。

### preset_genreカラムの3値セマンティクス
| 値 | 意味 | Wiki自動生成 |
|----|------|-------------|
| `NULL` | 旧来のspace（機能導入前に作成） | する（後方互換） |
| `'blank'` | ユーザーが明示的に「白紙」を選択 | しない |
| ジャンル名 | プリセット適用済み | しない（作成時に適用済み） |

### UI設計
- **SpaceCreateSheet**: 2ステップのbottom-sheet UI（Step1: ジャンル選択 → Step2: 名前入力+確認）
- **エントリポイント**: LeftNavの「チーム」セクションヘッダ横の「+」ボタン
- プロジェクトルート外（/inbox等）では「+」ボタンを非表示（fallback orgId問題の回避）

### ホームページのspecリンク
- RPC内ではplaceholderで作成し、API Route側でRPC完了後にspecページIDを取得して更新。
- 失敗しても致命的でない（リンクだけ未設定）。

### Codexレビュー対応
- fail-closed: preset_genreチェック失敗時は自動生成をスキップ（fail-openではなく）
- org_id境界チェック追加
- ホームページ更新をタグベースからIDベースに変更
- orgIdのUUIDバリデーション追加
- preset_genreカラムにCHECK制約追加

---

## 変更履歴

| バージョン | 日付 | 変更内容 |
|-----------|------|----------|
| v5.2 | 2026-02-14 | プロジェクトプリセットの意思決定追加 |
| v5.1 | 2025-02-03 | MCP連携の意思決定追加 |
| v5 | 2025-02-02 | 認証・招待・課金の意思決定追加 |
| v4 | - | レビュー・検討中・会議・代理入力・通知 |
