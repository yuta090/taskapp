# GitHub連携 & マイルストーン通知 設計書

> 作成日: 2024-02-08
> ステータス: 承認済み（実装待ち）

## 概要

GitHub PRのマージをトリガーにタスクを自動完了し、マイルストーン単位でクライアントに確認依頼を通知する。

## 設計方針

- **開発者の追加作業: ゼロ**（既存のTP-XXX命名規則を維持するだけ）
- **クライアントはGitHub不要**（TaskAppのみで完結）
- **シンプルな通知**（複雑な承認UIは作らない）

---

## 1. GitHub連携フロー

### 1.1 PRとタスクの紐付け（既存機能）

```
PR作成時:
  Title: "feat: TP-042 ログイン機能実装"
              ↓
  Webhook → task_linker.ts → task_github_links に自動登録
```

### 1.2 PRマージ時のタスク自動更新（新規）

```
┌─────────────────────────────────────────────────────────────────┐
│                                                                 │
│  GitHub                           TaskApp                       │
│  ┌──────────────┐                                               │
│  │ PR merged    │                                               │
│  │ to develop   │ ─── Webhook ───→ タスク status: done         │
│  └──────────────┘                   ball: internal              │
│                                                                 │
│  ┌──────────────┐                                               │
│  │ PR merged    │                                               │
│  │ to main      │ ─── Webhook ───→ ログ記録のみ（変更なし）    │
│  └──────────────┘                                               │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 1.3 ブランチ → アクション マッピング

| ブランチ | アクション | 備考 |
|---------|-----------|------|
| `develop` | タスク → `done` | ステージング環境へデプロイ |
| `main` / `master` | ログ記録 | 本番環境（将来拡張用） |
| その他 | 何もしない | feature branch等 |

設定で変更可能にする:
```typescript
// 将来的に設定画面で変更可能
const BRANCH_CONFIG = {
  developBranch: 'develop',      // done にするブランチ
  productionBranch: 'main',      // ログ記録するブランチ
}
```

---

## 2. マイルストーン完了通知

### 2.1 トリガー条件

```
マイルストーン内の全タスクが status: done になったとき
```

### 2.2 通知フロー

```
┌─────────────────────────────────────────────────────────────────┐
│                                                                 │
│  1. タスク更新 (status → done)                                  │
│                    ↓                                            │
│  2. マイルストーン完了チェック                                   │
│     「このマイルストーンの全タスクがdone?」                      │
│                    ↓ YES                                        │
│  3. クライアント通知                                             │
│     ├── inbox に「確認依頼」タスク作成                          │
│     └── プッシュ通知送信（メール等）                            │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 2.3 通知タスクの内容

```
┌─────────────────────────────────────────────────────────────────┐
│ 📬 確認依頼                                                     │
│                                                                 │
│ タイトル: 「Phase 1: 認証機能」の確認依頼                       │
│                                                                 │
│ 本文:                                                           │
│ 以下のマイルストーンの作業が完了しました。                      │
│ ステージング環境でご確認ください。                              │
│                                                                 │
│ ■ 完了したタスク                                                │
│ - TP-042: ログイン画面                                          │
│ - TP-043: ログアウト機能                                        │
│ - TP-044: パスワードリセット                                    │
│                                                                 │
│ ■ 確認環境                                                      │
│ https://staging.example.com                                     │
│                                                                 │
│ ご確認後、問題があれば各タスクにコメントをお願いします。        │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 2.4 クライアントのフィードバック方法

| 状況 | 対応方法 |
|-----|---------|
| 問題なし | コメントで「確認しました」 |
| 修正依頼 | 該当タスクのコメント欄に具体的に記載 |

**複雑な承認UIは作らない**。コメント欄で十分。

---

## 3. PRコメント → タスクコメント同期

### 3.1 同期する内容（低ノイズ・高シグナル）

| PRイベント | タスクコメントに追加 |
|-----------|---------------------|
| PR作成 | タイトル、作成者、リンク、本文の最初300文字 |
| PRマージ | マージステータス、コミットSHA、マージ者、対象ブランチ |
| PRクローズ（未マージ） | クローズ理由（あれば） |

### 3.2 同期しない内容

- インラインレビューコメント（ノイズが多い）
- CI/CDのステータス更新
- ラベル変更

---

## 4. データモデル変更

### 4.1 既存テーブル（変更なし）

- `tasks` - status, ball フィールドは既存のまま使用
- `task_github_links` - PR紐付け（既存）
- `github_pull_requests` - PR情報（既存）

### 4.2 新規: マイルストーン通知履歴

```sql
CREATE TABLE IF NOT EXISTS milestone_notifications (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id uuid NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  milestone_id uuid NOT NULL REFERENCES milestones(id) ON DELETE CASCADE,
  notification_type text NOT NULL DEFAULT 'completion', -- 'completion' | 'reminder'
  notified_at timestamptz NOT NULL DEFAULT now(),
  created_task_id uuid REFERENCES tasks(id), -- 通知タスクのID
  UNIQUE(milestone_id, notification_type) -- 同じ通知は1回のみ
);
```

### 4.3 設定テーブル（オプション）

```sql
-- spaces テーブルに追加
ALTER TABLE spaces ADD COLUMN IF NOT EXISTS
  github_auto_complete boolean DEFAULT true; -- PRマージで自動done

ALTER TABLE spaces ADD COLUMN IF NOT EXISTS
  milestone_notify_on_complete boolean DEFAULT true; -- 完了時に通知
```

---

## 5. 実装タスク

### Phase 1: PRマージ → タスク自動完了

1. [ ] `handlers.ts` 修正: PRマージ時にタスクステータス更新
2. [ ] ブランチ判定ロジック追加（develop/main）
3. [ ] 複数PR対応: 全PRクローズ時のみdoneに

### Phase 2: マイルストーン完了通知

1. [ ] タスク更新時のトリガー作成
2. [ ] マイルストーン完了チェックロジック
3. [ ] 通知タスク作成機能
4. [ ] メール通知（Resend連携）

### Phase 3: PRコメント同期（オプション）

1. [ ] PR作成時のコメント追加
2. [ ] PRマージ時のコメント追加

---

## 6. 設定画面（将来）

```
┌─────────────────────────────────────────────────────────────────┐
│ GitHub連携設定                                                  │
│                                                                 │
│ ☑ PRマージ時にタスクを自動完了する                             │
│                                                                 │
│   完了トリガーのブランチ: [develop    ▼]                       │
│                                                                 │
│ ☑ マイルストーン完了時にクライアントへ通知                     │
│                                                                 │
│   通知方法:                                                     │
│   ☑ 受信タスク作成                                             │
│   ☑ メール通知                                                 │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 7. エッジケース対応

| ケース | 対応 |
|-------|------|
| 1タスクに複数PR | 全PRがクローズされてからdone |
| PRリバート | 新しいPRとして扱う（タスクはdoneのまま） |
| ホットフィックス | 通常フローと同じ（マイルストーン外なら通知なし） |
| マイルストーン未設定タスク | マイルストーン通知対象外（タスク単体でdone） |
| 通知後にタスク追加 | 再度全完了時に通知するか設定で選択 |

---

## 8. 参考: 状態遷移

### タスク

```
backlog → todo → in_progress → done
                                 ↑
                          PRマージで自動遷移
```

### マイルストーン（通知のみ、ステータス変更なし）

```
作業中 ─────→ 全タスクdone ─────→ 通知送信
                                    │
                              クライアント確認
                                    │
                              コメントでやり取り
```

---

## 変更履歴

| 日付 | 内容 |
|-----|------|
| 2024-02-08 | 初版作成 |
